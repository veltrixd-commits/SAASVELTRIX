'use client';

import { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import type { ComponentType } from 'react';
import { AvatarImage } from '@/components/AvatarImage';
import { Users, CheckSquare, Clock, Plus, X, Calendar, Heart, BarChart3, UserCheck, Search, Filter, Paperclip, Link2, FileText, Image as ImageIcon, Video, ChevronDown, ChevronRight, TrendingUp, DollarSign, Activity, Zap, MapPin, Play, Square, Timer, Upload, Download, Target, MessageSquare, VideoIcon, Send, Camera, ArrowRight, Star, Sparkles, Brain, Battery, AlertTriangle, CheckCircle2, Circle, BarChart2, Flame } from 'lucide-react';
import { getCurrentUser } from '@/lib/auth';

// NEXT-GENERATION PRODUCTIVITY SYSTEM - OUTCOME-FIRST ARCHITECTURE

interface Outcome {
  id: string;
  title: string;
  description: string;
  outcome: string; // The actual result/value to deliver
  revenueImpact: number; // Expected revenue impact in R
  priority: 1 | 2 | 3; // 1 = Critical, 2 = High, 3 = Medium
  deadline: string;
  status: 'active' | 'completed' | 'blocked' | 'paused';
  owner: string;
  createdAt: string;
  completedAt?: string;
  actualRevenue?: number;
  tasks: ActionTask[]; // Auto-generated tasks
  dependencies: string[]; // Other outcome IDs
  progress: number; // 0-100%
}

interface ActionTask {
  id: string;
  outcomeId: string;
  title: string;
  description: string;
  estimatedMinutes: number;
  actualMinutes?: number;
  energyRequired: 'low' | 'medium' | 'high'; // Energy level needed
  valueScore: number; // AI-calculated value (0-100)
  status: 'pending' | 'in-progress' | 'completed' | 'skipped';
  scheduledFor?: string; // Auto-scheduled by AI
  completedAt?: string;
  dependencies: string[]; // Other task IDs
  autoGenerated: boolean; // Generated by AI or manual
}

interface DailyFocus {
  date: string;
  priority1: ActionTask | null;
  priority2: ActionTask | null;
  priority3: ActionTask | null;
  energyLevel: 'low' | 'medium' | 'high';
  focusMode: boolean;
  completedTasks: number;
  totalMinutes: number;
  valueCreated: number;
}

interface PerformanceMetrics {
  weeklyEfficiency: number; // Value created per hour
  outcomeCompletionRate: number; // % outcomes completed on time
  energyOptimization: number; // How well tasks match energy levels
  revenueRealized: number; // Actual revenue from completed outcomes
  burnoutRisk: number; // 0-100, higher = more risk
  improvementSuggestions: string[];
}

interface WellnessData {
  currentEnergy: 'low' | 'medium' | 'high';
  sleepHours: number;
  stressLevel: number; // 0-10
  lastBreak?: string;
  burnoutIndicators: string[];
  recommendedBreakTime?: string;
}

interface UserRole {
  type: 'individual' | 'employee' | 'creator' | 'business';
  metrics: string[]; // Role-specific metrics to track
  incentives: string[]; // Role-specific motivations
}

interface ClockEntry {
  id: string;
  employeeId: string;
  clockInTime: string;
  clockInLocation: { lat: number; lng: number; address: string };
  clockOutTime?: string;
  clockOutLocation?: { lat: number; lng: number; address: string };
  hoursWorked?: number;
  date: string;
  status: 'clocked-in' | 'clocked-out';
}

interface Employee {
  id: string;
  name: string;
  email: string;
  role: string;
  profilePicture: string;
  team?: string;
  wellness: number;
  tasksCompleted: number;
  tasksInProgress: number;
  tasksPending: number;
  joinedDate: string;
  // SALARY FEATURES
  salary?: number; // Monthly salary amount
  salaryFrequency?: 'monthly' | 'bi-weekly' | 'weekly';
  nextPaymentDate?: string;
  autoPayEnabled?: boolean;
  bankDetails?: {
    accountName: string;
    accountNumber: string;
    bank: string;
  };
}

interface SalaryPayment {
  id: string;
  employeeId: string;
  employeeName: string;
  amount: number;
  paymentDate: string;
  period: string; // e.g., "January 2026"
  status: 'pending' | 'paid' | 'failed';
  expenseId?: string; // Linked expense record
  paymentMethod: 'bank-transfer' | 'cash' | 'check';
  notes?: string;
}

interface EmployeeFinanceProfile {
  key: string;
  employeeId?: string;
  email: string;
  grossSalary: number;
  netSalary: number;
  paymentFrequency: 'weekly' | 'bi-weekly' | 'monthly';
  monthlyExpenses: number;
  emergencyFundTarget: number;
  allowOwnerView: boolean;
  updatedAt: string;
}

interface AutoPaymentSettings {
  enabled: boolean;
  paymentDay: number; // Day of month (1-31)
  notifyBeforePayment: boolean;
  notificationDays: number; // Days before payment to notify
  requireApproval: boolean;
}

interface TaskStage {
  id: string;
  name: string;
  completed: boolean;
  assets: TaskAsset[];
}

interface TaskAsset {
  id: string;
  type: 'note' | 'link' | 'file';
  title: string;
  content: string;
  url?: string;
  fileName?: string;
}

interface Task {
  id: string;
  title: string;
  description: string;
  assignedTo: string;
  deadline: string;
  priority: 'low' | 'medium' | 'high';
  status: 'To Do' | 'In Progress' | 'Completed';
  organizationalGoal?: string;
  budget: number;
  estimatedHours: number;
  actualHours: number;
  progress: number;
  stages: TaskStage[];
  assets: TaskAsset[];
}

interface Team {
  id: string;
  name: string;
  members: string[];
  color: string;
}

const VIEW_IDS = {
  'daily-os': 'deck-view-daily-os',
  'outcomes': 'deck-view-outcomes',
  'performance': 'deck-view-performance',
  'salaries': 'deck-view-salaries',
  'autopilot': 'deck-view-autopilot',
  'legacy': 'deck-view-legacy',
  'tasks': 'deck-view-tasks',
  'employees': 'deck-view-employees',
  'teams': 'deck-view-teams',
  'time-tracking': 'deck-view-time-tracking',
  'analytics': 'deck-view-analytics',
} as const;

type DeckView = keyof typeof VIEW_IDS;
type DeckModal = 'outcome' | 'task' | 'employee' | 'team' | 'wellness';

interface CommandDeckCard {
  id: DeckView;
  title: string;
  description: string;
  icon: ComponentType<{ className?: string }>;
  accent: string;
  metric: string;
  badge?: string;
  modal?: DeckModal;
}

export default function ProductivityPage() {
  // OUTCOME-FIRST STATE
  const [outcomes, setOutcomes] = useState<Outcome[]>([]);
  const [dailyFocus, setDailyFocus] = useState<DailyFocus | null>(null);
  const [wellnessData, setWellnessData] = useState<WellnessData>({
    currentEnergy: 'medium',
    sleepHours: 7,
    stressLevel: 5,
    burnoutIndicators: []
  });
  const [performanceMetrics, setPerformanceMetrics] = useState<PerformanceMetrics>({
    weeklyEfficiency: 0,
    outcomeCompletionRate: 0,
    energyOptimization: 0,
    revenueRealized: 0,
    burnoutRisk: 0,
    improvementSuggestions: []
  });
  const [userRole, setUserRole] = useState<UserRole>({
    type: 'individual',
    metrics: ['efficiency', 'value-created', 'energy-optimization'],
    incentives: ['achievement', 'growth', 'balance']
  });
  const [autopilotMode, setAutopilotMode] = useState(false);
  
  // SALARY PAYMENT STATE
  const [salaryPayments, setSalaryPayments] = useState<SalaryPayment[]>([]);
  const [autoPaymentSettings, setAutoPaymentSettings] = useState<AutoPaymentSettings>({
    enabled: true,
    paymentDay: 25,
    notifyBeforePayment: true,
    notificationDays: 3,
    requireApproval: false
  });
  const [showSalaryModal, setShowSalaryModal] = useState(false);
  const [pendingPayments, setPendingPayments] = useState<SalaryPayment[]>([]);
  const [currentUserMeta, setCurrentUserMeta] = useState<{ id: string; email: string; userType: 'individual' | 'employee' | 'creator' | 'business' }>({
    id: '',
    email: '',
    userType: 'individual',
  });
  const [employeeFinanceProfiles, setEmployeeFinanceProfiles] = useState<Record<string, EmployeeFinanceProfile>>({});
  const [employeeFinanceDraft, setEmployeeFinanceDraft] = useState({
    grossSalary: '',
    netSalary: '',
    paymentFrequency: 'monthly' as 'weekly' | 'bi-weekly' | 'monthly',
    monthlyExpenses: '',
    emergencyFundTarget: '',
    allowOwnerView: false,
  });
  
  // LEGACY STATE (for backward compatibility)
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [teams, setTeams] = useState<Team[]>([]);
  const [clockEntries, setClockEntries] = useState<ClockEntry[]>([]);
  
  // UI STATE
  const [activeView, setActiveView] = useState<DeckView>('daily-os');
  const [showOutcomeModal, setShowOutcomeModal] = useState(false);
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [showWellnessModal, setShowWellnessModal] = useState(false);
  const [selectedOutcome, setSelectedOutcome] = useState<Outcome | null>(null);
  const [selectedTask, setSelectedTask] = useState<ActionTask | Task | null>(null);
  const [focusMode, setFocusMode] = useState(false);
  const [showMessageModal, setShowMessageModal] = useState(false);
  const [messageRecipient, setMessageRecipient] = useState<Employee | null>(null);
  const [messageText, setMessageText] = useState('');
  const [showMeetingModal, setShowMeetingModal] = useState(false);
  const [selectedTeamForMeeting, setSelectedTeamForMeeting] = useState<Team | null>(null);
  const [showProfileUploadModal, setShowProfileUploadModal] = useState(false);
  const [uploadingEmployee, setUploadingEmployee] = useState<Employee | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [showAssetModal, setShowAssetModal] = useState(false);
  const [expandedTasks, setExpandedTasks] = useState<Set<string>>(new Set());
  const [currentLocation, setCurrentLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [locationError, setLocationError] = useState<string>('');
  const [isLoadingLocation, setIsLoadingLocation] = useState(false);
  const [uploadingStageId, setUploadingStageId] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  
  // NEW OUTCOME FORM STATE
  const [newOutcome, setNewOutcome] = useState({
    title: '',
    description: '',
    outcome: '',
    revenueImpact: '',
    priority: 1 as 1 | 2 | 3,
    deadline: '',
    owner: 'You'
  });

  const [newManualTask, setNewManualTask] = useState({
    title: '',
    description: '',
    estimatedMinutes: '',
    energyRequired: 'medium' as 'low' | 'medium' | 'high'
  });

  // LEGACY STATE FOR BACKWARD COMPATIBILITY
  const [tasks, setTasks] = useState<any[]>([]);
  const [newAsset, setNewAsset] = useState<{ type: 'note' | 'link' | 'file'; title: string; content: string; stageId: string }>({ 
    type: 'note',
    title: '', 
    content: '', 
    stageId: '' 
  });
  const [showEmployeeModal, setShowEmployeeModal] = useState(false);
  const [showTeamModal, setShowTeamModal] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<Employee | null>(null);
  const [newEmployee, setNewEmployee] = useState({
    name: '',
    email: '',
    role: '',
    team: '',
    profilePicture: 'ðŸ‘¤',
    salary: '',
    paymentFrequency: 'monthly' as 'weekly' | 'bi-weekly' | 'monthly',
    nextPaymentDate: ''
  });
  const [newTeam, setNewTeam] = useState({
    name: '',
    color: '#3b82f6'
  });
  const [newTask, setNewTask] = useState({
    title: '',
    description: '',
    assignedTo: '',
    deadline: '',
    priority: 'medium' as 'low' | 'medium' | 'high',
    stagesList: '',
    budget: '',
    estimatedHours: '',
    organizationalGoal: ''
  });

  // LOAD DATA FROM LOCALSTORAGE
  useEffect(() => {
    const savedOutcomes = localStorage.getItem('productivityOutcomes');
    const savedDailyFocus = localStorage.getItem('productivityDailyFocus');
    const savedWellness = localStorage.getItem('productivityWellness');
    const savedPerformance = localStorage.getItem('productivityPerformance');
    const savedRole = localStorage.getItem('productivityUserRole');
    const savedAutopilot = localStorage.getItem('productivityAutopilot');
    const savedEmployees = localStorage.getItem('productivityEmployees');
    const savedTeams = localStorage.getItem('productivityTeams');
    const savedSalaryPayments = localStorage.getItem('productivitySalaryPayments');
    const savedAutoPaymentSettings = localStorage.getItem('productivityAutoPaymentSettings');
    const savedEmployeeFinanceProfiles = localStorage.getItem('productivityEmployeeFinanceProfiles');
    const currentUser = getCurrentUser();

    if (currentUser) {
      setCurrentUserMeta({
        id: String(currentUser.id || '').trim().toLowerCase(),
        email: String(currentUser.email || '').trim().toLowerCase(),
        userType: (currentUser.userType || 'individual') as 'individual' | 'employee' | 'creator' | 'business',
      });
    }

    if (savedOutcomes) setOutcomes(JSON.parse(savedOutcomes));
    if (savedDailyFocus) setDailyFocus(JSON.parse(savedDailyFocus));
    if (savedWellness) setWellnessData(JSON.parse(savedWellness));
    if (savedPerformance) setPerformanceMetrics(JSON.parse(savedPerformance));
    if (savedRole) setUserRole(JSON.parse(savedRole));
    if (savedAutopilot) setAutopilotMode(JSON.parse(savedAutopilot));
    if (savedEmployees) setEmployees(JSON.parse(savedEmployees));
    if (savedTeams) setTeams(JSON.parse(savedTeams));
    if (savedSalaryPayments) setSalaryPayments(JSON.parse(savedSalaryPayments));
    if (savedAutoPaymentSettings) setAutoPaymentSettings(JSON.parse(savedAutoPaymentSettings));
    if (savedEmployeeFinanceProfiles) {
      const parsed = JSON.parse(savedEmployeeFinanceProfiles);
      setEmployeeFinanceProfiles(parsed);
    }

    // Initialize with demo data if empty
    if (!savedOutcomes) {
      const demoOutcomes: Outcome[] = [
        {
          id: '1',
          title: 'Launch New Product Line',
          description: 'Complete development and market launch of innovative product suite',
          outcome: 'Generate R500,000 in first-quarter revenue with 200+ customers',
          revenueImpact: 500000,
          priority: 1,
          deadline: '2026-03-15',
          status: 'active',
          owner: 'You',
          createdAt: new Date('2026-02-01').toISOString(),
          tasks: [],
          dependencies: [],
          progress: 0
        },
        {
          id: '2',
          title: 'Expand Customer Base',
          description: 'Scale customer acquisition through digital marketing',
          outcome: 'Achieve 500 new qualified leads and convert 15% to paying customers',
          revenueImpact: 250000,
          priority: 2,
          deadline: '2026-03-30',
          status: 'active',
          owner: 'You',
          createdAt: new Date('2026-02-05').toISOString(),
          tasks: [],
          dependencies: [],
          progress: 0
        }
      ];
      setOutcomes(demoOutcomes);
      localStorage.setItem('productivityOutcomes', JSON.stringify(demoOutcomes));
      
      // Auto-generate tasks for demo outcomes
      setTimeout(() => generateTasksForOutcome('1'), 100);
      setTimeout(() => generateTasksForOutcome('2'), 200);
    }

    if (!savedEmployees) {
      const demoEmployees: Employee[] = [
        {
          id: '1',
          name: 'Sarah Johnson',
          email: 'sarah@company.com',
          role: 'Product Manager',
          profilePicture: 'ðŸ‘©â€ðŸ’¼',
          team: 'Product',
          wellness: 85,
          tasksCompleted: 24,
          tasksInProgress: 3,
          tasksPending: 2,
          joinedDate: '2024-01-15',
          salary: 45000,
          salaryFrequency: 'monthly',
          nextPaymentDate: '2026-03-25',
          autoPayEnabled: true,
          bankDetails: {
            accountName: 'Sarah Johnson',
            accountNumber: '1234567890',
            bank: 'Standard Bank'
          }
        },
        {
          id: '2',
          name: 'Michael Chen',
          email: 'michael@company.com',
          role: 'Marketing Lead',
          profilePicture: 'ðŸ‘¨â€ðŸ’»',
          team: 'Marketing',
          wellness: 78,
          tasksCompleted: 31,
          tasksInProgress: 4,
          tasksPending: 1,
          joinedDate: '2024-02-01',
          salary: 38000,
          salaryFrequency: 'monthly',
          nextPaymentDate: '2026-03-25',
          autoPayEnabled: true,
          bankDetails: {
            accountName: 'Michael Chen',
            accountNumber: '0987654321',
            bank: 'FNB'
          }
        }
      ];
      setEmployees(demoEmployees);
      localStorage.setItem('productivityEmployees', JSON.stringify(demoEmployees));
    }

    if (!savedTeams) {
      const demoTeams: Team[] = [
        { id: '1', name: 'Product', members: ['1'], color: '#3b82f6' },
        { id: '2', name: 'Marketing', members: ['2'], color: '#10b981' }
      ];
      setTeams(demoTeams);
      localStorage.setItem('productivityTeams', JSON.stringify(demoTeams));
    }

    // Generate today's focus if not exists
    if (!savedDailyFocus || JSON.parse(savedDailyFocus).date !== new Date().toISOString().split('T')[0]) {
      generateDailyFocus();
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('productivityEmployeeFinanceProfiles', JSON.stringify(employeeFinanceProfiles));
  }, [employeeFinanceProfiles]);

  useEffect(() => {
    const key = currentUserMeta.email || currentUserMeta.id;
    if (!key) return;
    const existing = employeeFinanceProfiles[key];
    if (!existing) return;

    setEmployeeFinanceDraft({
      grossSalary: existing.grossSalary ? String(existing.grossSalary) : '',
      netSalary: existing.netSalary ? String(existing.netSalary) : '',
      paymentFrequency: existing.paymentFrequency,
      monthlyExpenses: existing.monthlyExpenses ? String(existing.monthlyExpenses) : '',
      emergencyFundTarget: existing.emergencyFundTarget ? String(existing.emergencyFundTarget) : '',
      allowOwnerView: Boolean(existing.allowOwnerView),
    });
  }, [currentUserMeta.email, currentUserMeta.id, employeeFinanceProfiles]);

  // SAVE DATA TO LOCALSTORAGE
  useEffect(() => {
    if (outcomes.length > 0) {
      localStorage.setItem('productivityOutcomes', JSON.stringify(outcomes));
      calculatePerformanceMetrics();
    }
  }, [outcomes]);

  useEffect(() => {
    if (dailyFocus) {
      localStorage.setItem('productivityDailyFocus', JSON.stringify(dailyFocus));
    }
  }, [dailyFocus]);

  useEffect(() => {
    localStorage.setItem('productivityWellness', JSON.stringify(wellnessData));
    checkBurnoutRisk();
  }, [wellnessData]);

  useEffect(() => {
    localStorage.setItem('productivityPerformance', JSON.stringify(performanceMetrics));
  }, [performanceMetrics]);

  useEffect(() => {
    localStorage.setItem('productivityUserRole', JSON.stringify(userRole));
  }, [userRole]);

  useEffect(() => {
    localStorage.setItem('productivityAutopilot', JSON.stringify(autopilotMode));
  }, [autopilotMode]);

  useEffect(() => {
    const saved = localStorage.getItem('clockEntries');
    if (saved) {
      setClockEntries(JSON.parse(saved));
    }
  }, []);

  useEffect(() => {
    if (clockEntries.length > 0) {
      localStorage.setItem('clockEntries', JSON.stringify(clockEntries));
    }
  }, [clockEntries]);

  // Get geolocation
  const getLocation = (): Promise<{ lat: number; lng: number; address: string }> => {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject('Geolocation is not supported by your browser');
        return;
      }

      setIsLoadingLocation(true);
      setLocationError('');

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          // Reverse geocoding using free service (nominatim)
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
            );
            const data = await response.json();
            const address = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            
            setIsLoadingLocation(false);
            resolve({ lat, lng, address });
          } catch (error) {
            setIsLoadingLocation(false);
            resolve({ lat, lng, address: `${lat.toFixed(4)}, ${lng.toFixed(4)}` });
          }
        },
        (error) => {
          setIsLoadingLocation(false);
          setLocationError('Unable to retrieve location. Please enable location services.');
          reject(error.message);
        }
      );
    });
  };

  const clockIn = async (employeeId: string) => {
    try {
      const location = await getLocation();
      const now = new Date().toISOString();
      const today = new Date().toDateString();
      
      // Check if already clocked in today
      const existingEntry = clockEntries.find(
        entry => entry.employeeId === employeeId && 
                 entry.date === today && 
                 entry.status === 'clocked-in'
      );
      
      if (existingEntry) {
        alert('You are already clocked in for today!');
        return;
      }

      const newEntry: ClockEntry = {
        id: Date.now().toString(),
        employeeId,
        clockInTime: now,
        clockInLocation: location,
        date: today,
        status: 'clocked-in'
      };

      setClockEntries([...clockEntries, newEntry]);
      alert(`Clocked in successfully at ${new Date(now).toLocaleTimeString()}`);
    } catch (error) {
      alert(`Clock in failed: ${error}`);
    }
  };

  const clockOut = async (employeeId: string) => {
    try {
      const location = await getLocation();
      const now = new Date().toISOString();
      const today = new Date().toDateString();
      
      const entry = clockEntries.find(
        e => e.employeeId === employeeId && 
             e.date === today && 
             e.status === 'clocked-in'
      );
      
      if (!entry) {
        alert('You need to clock in first!');
        return;
      }

      const clockInDate = new Date(entry.clockInTime);
      const clockOutDate = new Date(now);
      const hoursWorked = (clockOutDate.getTime() - clockInDate.getTime()) / (1000 * 60 * 60);

      const updatedEntry: ClockEntry = {
        ...entry,
        clockOutTime: now,
        clockOutLocation: location,
        hoursWorked: parseFloat(hoursWorked.toFixed(2)),
        status: 'clocked-out'
      };

      setClockEntries(clockEntries.map(e => e.id === entry.id ? updatedEntry : e));
      alert(`Clocked out successfully! Hours worked: ${hoursWorked.toFixed(2)}`);
    } catch (error) {
      alert(`Clock out failed: ${error}`);
    }
  };

  const getTodayClockStatus = (employeeId: string) => {
    const today = new Date().toDateString();
    return clockEntries.find(
      e => e.employeeId === employeeId && e.date === today
    );
  };

  const getTotalHoursWorked = (employeeId: string, days: number = 7) => {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    return clockEntries
      .filter(e => e.employeeId === employeeId && 
                   e.hoursWorked && 
                   new Date(e.clockInTime) >= cutoffDate)
      .reduce((sum, e) => sum + (e.hoursWorked || 0), 0);
  };

  // ============================================
  // ðŸ’° SALARY PAYMENT SYSTEM
  // ============================================

  const createExpenseFromSalary = (payment: SalaryPayment): string => {
    // Create expense record that will be saved to Finance module
    const expenseId = `expense-salary-${Date.now()}`;
    
    const expenseRecord = {
      id: expenseId,
      category: 'Salaries',
      subcategory: 'Employee Compensation',
      amount: payment.amount,
      description: `Salary payment to ${payment.employeeName} - ${payment.period}`,
      date: payment.paymentDate,
      paymentMethod: payment.paymentMethod,
      status: 'paid',
      paidTo: payment.employeeName,
      receiptUrl: '',
      tags: ['salary', 'payroll', 'personnel'],
      recurring: true,
      notes: payment.notes || `Automated salary payment via Productivity System`,
      linkedPaymentId: payment.id
    };

    // Save to Finance expenses
    try {
      const savedExpenses = localStorage.getItem('expenses');
      const expenses = savedExpenses ? JSON.parse(savedExpenses) : [];
      expenses.push(expenseRecord);
      localStorage.setItem('expenses', JSON.stringify(expenses));
      
      console.log('âœ… Expense record created:', expenseId);
    } catch (error) {
      console.error('âŒ Failed to create expense record:', error);
    }

    return expenseId;
  };

  const checkDuePayments = () => {
    const today = new Date();
    const todayDay = today.getDate();
    const todayString = today.toISOString().split('T')[0];

    const dueEmployees = employees.filter(employee => {
      if (!employee.salary || !employee.autoPayEnabled) return false;

      // Check if payment is due today
      if (employee.nextPaymentDate === todayString) return true;

      // Fallback: check if today matches payment day for monthly
      if (employee.salaryFrequency === 'monthly' && todayDay === autoPaymentSettings.paymentDay) {
        // Check if not already paid this month
        const thisMonth = `${today.toLocaleString('default', { month: 'long' })} ${today.getFullYear()}`;
        const alreadyPaid = salaryPayments.some(p => 
          p.employeeId === employee.id && 
          p.period === thisMonth && 
          p.status === 'paid'
        );
        return !alreadyPaid;
      }

      return false;
    });

    if (dueEmployees.length > 0) {
      const pending: SalaryPayment[] = dueEmployees.map(employee => ({
        id: `pending-${employee.id}-${Date.now()}`,
        employeeId: employee.id,
        employeeName: employee.name,
        amount: employee.salary!,
        paymentDate: todayString,
        period: `${today.toLocaleString('default', { month: 'long' })} ${today.getFullYear()}`,
        status: 'pending',
        paymentMethod: 'bank-transfer',
        notes: 'Automated payment due'
      }));

      setPendingPayments(pending);

      // Auto-process if approval not required
      if (autoPaymentSettings.enabled && !autoPaymentSettings.requireApproval) {
        pending.forEach(payment => {
          processSalaryPayment(payment.employeeId, payment.notes);
        });
        setPendingPayments([]);
      } else {
        // Show notification
        alert(`ðŸ’° ${pending.length} salary payment(s) require approval`);
      }
    }
  };

  // Auto-check for due payments (runs daily)
  useEffect(() => {
    if (!autoPaymentSettings.enabled) return;

    // Check immediately on load
    checkDuePayments();

    // Check every hour
    const interval = setInterval(() => {
      checkDuePayments();
    }, 60 * 60 * 1000); // 1 hour

    return () => clearInterval(interval);
  }, [employees, autoPaymentSettings, salaryPayments]);

  // Save salary data to localStorage
  useEffect(() => {
    if (salaryPayments.length > 0) {
      localStorage.setItem('productivitySalaryPayments', JSON.stringify(salaryPayments));
    }
  }, [salaryPayments]);

  useEffect(() => {
    localStorage.setItem('productivityAutoPaymentSettings', JSON.stringify(autoPaymentSettings));
  }, [autoPaymentSettings]);

  // ============================================
  // ðŸ¤– AI OUTCOME ENGINE - AUTO TASK GENERATION
  // ============================================
  
  const generateTasksForOutcome = (outcomeId: string) => {
    const outcome = outcomes.find(o => o.id === outcomeId);
    if (!outcome) return;

    // AI analyzes outcome and auto-generates tasks
    const aiGeneratedTasks: ActionTask[] = [];
    const keywords = outcome.title.toLowerCase();
    
    if (keywords.includes('launch') || keywords.includes('product')) {
      aiGeneratedTasks.push(
        {
          id: `task-${Date.now()}-1`,
          outcomeId: outcome.id,
          title: 'Complete Product Specifications',
          description: 'Finalize all technical and functional requirements for product launch',
          estimatedMinutes: 180,
          energyRequired: 'high',
          valueScore: 95,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-2`,
          outcomeId: outcome.id,
          title: 'Develop Marketing Campaign',
          description: 'Create comprehensive marketing strategy and content for product launch',
          estimatedMinutes: 240,
          energyRequired: 'high',
          valueScore: 90,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-3`,
          outcomeId: outcome.id,
          title: 'Set Up Sales Infrastructure',
          description: 'Configure payment systems, CRM, and sales processes',
          estimatedMinutes: 120,
          energyRequired: 'medium',
          valueScore: 85,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-4`,
          outcomeId: outcome.id,
          title: 'Create Customer Onboarding Flow',
          description: 'Design and implement seamless customer onboarding experience',
          estimatedMinutes: 150,
          energyRequired: 'medium',
          valueScore: 80,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-5`,
          outcomeId: outcome.id,
          title: 'Execute Launch Campaign',
          description: 'Deploy marketing campaign and monitor initial customer response',
          estimatedMinutes: 90,
          energyRequired: 'high',
          valueScore: 100,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        }
      );
    } else if (keywords.includes('customer') || keywords.includes('marketing')) {
      aiGeneratedTasks.push(
        {
          id: `task-${Date.now()}-1`,
          outcomeId: outcome.id,
          title: 'Optimize Ad Campaigns',
          description: 'Review and optimize all active advertising campaigns for better ROI',
          estimatedMinutes: 120,
          energyRequired: 'medium',
          valueScore: 90,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-2`,
          outcomeId: outcome.id,
          title: 'Create Content Strategy',
          description: 'Develop 30-day content calendar with engaging posts',
          estimatedMinutes: 180,
          energyRequired: 'high',
          valueScore: 85,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-3`,
          outcomeId: outcome.id,
          title: 'Build Email Nurture Sequences',
          description: 'Create automated email sequences for lead nurturing',
          estimatedMinutes: 150,
          energyRequired: 'medium',
          valueScore: 80,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-4`,
          outcomeId: outcome.id,
          title: 'Launch Referral Program',
          description: 'Design and implement customer referral incentive program',
          estimatedMinutes: 120,
          energyRequired: 'medium',
          valueScore: 75,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        }
      );
    } else {
      // Generic high-value tasks
      aiGeneratedTasks.push(
        {
          id: `task-${Date.now()}-1`,
          outcomeId: outcome.id,
          title: 'Plan Strategic Approach',
          description: 'Define clear strategy and action plan for achieving outcome',
          estimatedMinutes: 90,
          energyRequired: 'high',
          valueScore: 85,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-2`,
          outcomeId: outcome.id,
          title: 'Execute Core Activities',
          description: 'Complete primary tasks required for outcome delivery',
          estimatedMinutes: 240,
          energyRequired: 'high',
          valueScore: 95,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        },
        {
          id: `task-${Date.now()}-3`,
          outcomeId: outcome.id,
          title: 'Monitor and Adjust',
          description: 'Track progress and make necessary adjustments',
          estimatedMinutes: 60,
          energyRequired: 'low',
          valueScore: 70,
          status: 'pending',
          dependencies: [],
          autoGenerated: true
        }
      );
    }

    // Update outcome with generated tasks
    setOutcomes(outcomes.map(o => 
      o.id === outcomeId 
        ? { ...o, tasks: aiGeneratedTasks }
        : o
    ));
  };

  // ============================================
  // ðŸ“… DAILY OPERATING SYSTEM - AI PRIORITIZATION
  // ============================================
  
  const generateDailyFocus = () => {
    const allTasks: ActionTask[] = [];
    outcomes.forEach(outcome => {
      if (outcome.status === 'active') {
        outcome.tasks.forEach(task => {
          if (task.status === 'pending' || task.status === 'in-progress') {
            allTasks.push(task);
          }
        });
      }
    });

    if (allTasks.length === 0) {
      setDailyFocus({
        date: new Date().toISOString().split('T')[0],
        priority1: null,
        priority2: null,
        priority3: null,
        energyLevel: wellnessData.currentEnergy,
        focusMode: false,
        completedTasks: 0,
        totalMinutes: 0,
        valueCreated: 0
      });
      return;
    }

    // AI scoring: value Ã— urgency Ã— energy match
    const scoredTasks = allTasks.map(task => {
      const outcome = outcomes.find(o => o.id === task.outcomeId);
      const urgencyScore = outcome ? (4 - outcome.priority) * 25 : 50; // Closer deadline = higher urgency
      const energyMatch = task.energyRequired === wellnessData.currentEnergy ? 1.2 : 1.0;
      const aiScore = task.valueScore * (urgencyScore / 100) * energyMatch;
      
      return { task, aiScore };
    });

    // Sort by AI score descending
    scoredTasks.sort((a, b) => b.aiScore - a.aiScore);

    // Select top 3 tasks matching energy level
    const energyMatchedTasks = scoredTasks.filter(st => 
      st.task.energyRequired === wellnessData.currentEnergy || 
      (wellnessData.currentEnergy === 'medium')
    );

    const top3 = energyMatchedTasks.slice(0, 3);

    setDailyFocus({
      date: new Date().toISOString().split('T')[0],
      priority1: top3[0]?.task || null,
      priority2: top3[1]?.task || null,
      priority3: top3[2]?.task || null,
      energyLevel: wellnessData.currentEnergy,
      focusMode: false,
      completedTasks: 0,
      totalMinutes: 0,
      valueCreated: 0
    });
  };

  // ============================================
  // ðŸ“Š PERFORMANCE TRACKING & ANALYTICS
  // ============================================
  
  const calculatePerformanceMetrics = () => {
    const completedTasks: ActionTask[] = [];
    let totalMinutes = 0;
    let totalValue = 0;
    let energyMatchCount = 0;
    let totalTasksForEnergyCalc = 0;

    outcomes.forEach(outcome => {
      outcome.tasks.forEach(task => {
        if (task.status === 'completed' && task.actualMinutes) {
          completedTasks.push(task);
          totalMinutes += task.actualMinutes;
          totalValue += task.valueScore;
          totalTasksForEnergyCalc++;
          
          // Estimate if energy matched (simplified)
          if (task.energyRequired === wellnessData.currentEnergy) {
            energyMatchCount++;
          }
        }
      });
    });

    const weeklyEfficiency = totalMinutes > 0 ? (totalValue / (totalMinutes / 60)) : 0;
    
    const completedOutcomes = outcomes.filter(o => o.status === 'completed');
    const totalOutcomes = outcomes.length;
    const outcomeCompletionRate = totalOutcomes > 0 ? (completedOutcomes.length / totalOutcomes) * 100 : 0;
    
    const energyOptimization = totalTasksForEnergyCalc > 0 ? (energyMatchCount / totalTasksForEnergyCalc) * 100 : 0;
    
    const revenueRealized = completedOutcomes.reduce((sum, o) => sum + (o.actualRevenue || 0), 0);

    // Generate AI improvement suggestions
    const suggestions: string[] = [];
    if (weeklyEfficiency < 50) {
      suggestions.push('Focus on high-value tasks (valueScore > 80) for better efficiency');
    }
    if (energyOptimization < 60) {
      suggestions.push('Schedule high-energy tasks during your peak energy times');
    }
    if (performanceMetrics.burnoutRisk > 70) {
      suggestions.push('Take breaks: Your burnout risk is high. Consider reducing task load');
    }
    if (outcomeCompletionRate < 70) {
      suggestions.push('Break down outcomes into smaller, achievable tasks');
    }

    setPerformanceMetrics({
      weeklyEfficiency: Math.round(weeklyEfficiency),
      outcomeCompletionRate: Math.round(outcomeCompletionRate),
      energyOptimization: Math.round(energyOptimization),
      revenueRealized,
      burnoutRisk: performanceMetrics.burnoutRisk,
      improvementSuggestions: suggestions
    });
  };

  // ============================================
  // ðŸ’š WELLNESS INTEGRATION & BURNOUT DETECTION
  // ============================================
  
  const checkBurnoutRisk = () => {
    let riskScore = 0;

    // Sleep factor (0-30 points)
    if (wellnessData.sleepHours < 6) riskScore += 30;
    else if (wellnessData.sleepHours < 7) riskScore += 20;
    else if (wellnessData.sleepHours < 8) riskScore += 10;

    // Stress factor (0-40 points)
    riskScore += wellnessData.stressLevel * 4;

    // Energy factor (0-30 points)
    if (wellnessData.currentEnergy === 'low') riskScore += 30;
    else if (wellnessData.currentEnergy === 'medium') riskScore += 15;

    // Update burnout indicators
    const indicators: string[] = [];
    if (wellnessData.sleepHours < 6) indicators.push('Insufficient sleep');
    if (wellnessData.stressLevel > 7) indicators.push('High stress levels');
    if (wellnessData.currentEnergy === 'low') indicators.push('Low energy');
    if (!wellnessData.lastBreak) indicators.push('No recent breaks recorded');

    setWellnessData({
      ...wellnessData,
      burnoutIndicators: indicators
    });

    setPerformanceMetrics(prev => ({
      ...prev,
      burnoutRisk: Math.min(riskScore, 100)
    }));

    // Auto-adjust task load if burnout risk high
    if (autopilotMode && riskScore > 70) {
      // Reduce daily focus to 1-2 tasks
      if (dailyFocus && dailyFocus.priority3) {
        setDailyFocus({
          ...dailyFocus,
          priority3: null
        });
      }
    }
  };

  // ============================================
  // âš¡ OUTCOME & TASK MANAGEMENT
  // ============================================
  
  const createOutcome = () => {
    if (!newOutcome.title || !newOutcome.outcome || !newOutcome.deadline) {
      alert('âš ï¸ Please fill in all required fields: Title, Outcome, and Deadline');
      return;
    }

    const outcome: Outcome = {
      id: `outcome-${Date.now()}`,
      title: newOutcome.title,
      description: newOutcome.description,
      outcome: newOutcome.outcome,
      revenueImpact: parseFloat(newOutcome.revenueImpact) || 0,
      priority: newOutcome.priority,
      deadline: newOutcome.deadline,
      status: 'active',
      owner: newOutcome.owner,
      createdAt: new Date().toISOString(),
      tasks: [],
      dependencies: [],
      progress: 0
    };

    setOutcomes([...outcomes, outcome]);
    setShowOutcomeModal(false);
    setNewOutcome({ title: '', description: '', outcome: '', revenueImpact: '', priority: 1, deadline: '', owner: 'You' });

    // Auto-generate tasks if autopilot is on
    if (autopilotMode) {
      setTimeout(() => generateTasksForOutcome(outcome.id), 500);
    }
  };

  const addManualTask = () => {
    if (!selectedOutcome || !newManualTask.title) {
      alert('âš ï¸ Please enter task title');
      return;
    }

    const task: ActionTask = {
      id: `task-${Date.now()}`,
      outcomeId: selectedOutcome.id,
      title: newManualTask.title,
      description: newManualTask.description,
      estimatedMinutes: parseFloat(newManualTask.estimatedMinutes) || 30,
      energyRequired: newManualTask.energyRequired,
      valueScore: 75, // Default value score for manual tasks
      status: 'pending',
      dependencies: [],
      autoGenerated: false
    };

    setOutcomes(outcomes.map(o => 
      o.id === selectedOutcome.id 
        ? { ...o, tasks: [...o.tasks, task] }
        : o
    ));

    setNewManualTask({ title: '', description: '', estimatedMinutes: '', energyRequired: 'medium' });
    setShowTaskModal(false);
  };

  const completeTask = (taskId: string, actualMinutes: number) => {
    setOutcomes(outcomes.map(outcome => ({
      ...outcome,
      tasks: outcome.tasks.map(task => 
        task.id === taskId 
          ? { 
              ...task, 
              status: 'completed' as const, 
              completedAt: new Date().toISOString(),
              actualMinutes 
            }
          : task
      )
    })));

    // Update daily focus if this was a priority task
    if (dailyFocus) {
      let newCompletedCount = dailyFocus.completedTasks + 1;
      let newTotalMinutes = dailyFocus.totalMinutes + actualMinutes;
      let newValueCreated = dailyFocus.valueCreated;
      
      // Find task to get value score
      outcomes.forEach(outcome => {
        const task = outcome.tasks.find(t => t.id === taskId);
        if (task) {
          newValueCreated += task.valueScore;
        }
      });

      setDailyFocus({
        ...dailyFocus,
        completedTasks: newCompletedCount,
        totalMinutes: newTotalMinutes,
        valueCreated: newValueCreated
      });
    }

    // Recalculate outcome progress
    const outcome = outcomes.find(o => o.tasks.some(t => t.id === taskId));
    if (outcome) {
      const completedTasks = outcome.tasks.filter(t => t.status === 'completed').length;
      const totalTasks = outcome.tasks.length;
      const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
      
      setOutcomes(outcomes.map(o => 
        o.id === outcome.id 
          ? { ...o, progress: Math.round(progress) }
          : o
      ));
    }
  };

  const startTask = (taskId: string) => {
    setOutcomes(outcomes.map(outcome => ({
      ...outcome,
      tasks: outcome.tasks.map(task => 
        task.id === taskId 
          ? { ...task, status: 'in-progress' as const }
          : task
      )
    })));
  };

  const completeOutcome = (outcomeId: string, actualRevenue: number) => {
    setOutcomes(outcomes.map(o => 
      o.id === outcomeId 
        ? { 
            ...o, 
            status: 'completed' as const, 
            completedAt: new Date().toISOString(),
            actualRevenue,
            progress: 100
          }
        : o
    ));
  };

  // LEGACY FUNCTION STUBS FOR BACKWARD COMPATIBILITY
  const createTask = () => {
    if (!newTask.title) {
      alert('âš ï¸ Please enter task title');
      return;
    }

    const stagesArray = newTask.stagesList ? newTask.stagesList.split('\n').filter(s => s.trim()) : [];
    
    const task = {
      id: `task-${Date.now()}`,
      title: newTask.title,
      description: newTask.description,
      assignedTo: newTask.assignedTo,
      deadline: newTask.deadline,
      priority: newTask.priority,
      status: 'To Do' as const,
      organizationalGoal: newTask.organizationalGoal,
      budget: parseFloat(newTask.budget) || 0,
      estimatedHours: parseFloat(newTask.estimatedHours) || 0,
      actualHours: 0,
      progress: 0,
      stages: stagesArray.map((stage, index) => ({
        id: `stage-${Date.now()}-${index}`,
        name: stage,
        completed: false,
        assets: []
      })),
      assets: []
    };

    setTasks([...tasks, task]);
    setShowTaskModal(false);
    setNewTask({
      title: '',
      description: '',
      assignedTo: '',
      deadline: '',
      priority: 'medium',
      stagesList: '',
      budget: '',
      estimatedHours: '',
      organizationalGoal: ''
    });
  };

  const addEmployee = () => {
    if (!newEmployee.name || !newEmployee.email) {
      alert('âš ï¸ Please enter employee name and email');
      return;
    }

    const employee: Employee = {
      id: `emp-${Date.now()}`,
      name: newEmployee.name,
      email: newEmployee.email,
      role: newEmployee.role,
      team: newEmployee.team,
      profilePicture: newEmployee.profilePicture || 'ðŸ‘¤',
      wellness: 70,
      tasksCompleted: 0,
      tasksInProgress: 0,
      tasksPending: 0,
      joinedDate: new Date().toISOString(),
      salary: parseFloat(newEmployee.salary) || undefined,
      salaryFrequency: newEmployee.paymentFrequency,
      nextPaymentDate: newEmployee.nextPaymentDate,
      autoPayEnabled: false
    };

    setEmployees([...employees, employee]);
    setShowEmployeeModal(false);
    setNewEmployee({
      name: '',
      email: '',
      role: '',
      team: '',
      profilePicture: 'ðŸ‘¤',
      salary: '',
      paymentFrequency: 'monthly',
      nextPaymentDate: ''
    });
  };

  const createTeam = () => {
    if (!newTeam.name) {
      alert('âš ï¸ Please enter team name');
      return;
    }

    const team: Team = {
      id: `team-${Date.now()}`,
      name: newTeam.name,
      members: [],
      color: newTeam.color || '#3b82f6'
    };

    setTeams([...teams, team]);
    setShowTeamModal(false);
    setNewTeam({
      name: '',
      color: '#3b82f6'
    });
  };

  const updateTaskStatus = (taskId: string, newStatus: any) => {
    // Legacy function - compatibility only
  };

  const getEmployeeById = (id: string) => employees.find(emp => emp.id === id);
  const getTeamMembers = (teamName: string) => employees.filter(emp => emp.team === teamName);
  
  // SALARY PAYMENT FUNCTIONS
  const calculateNextPaymentDate = (frequency: 'weekly' | 'bi-weekly' | 'monthly'): string => {
    const today = new Date();
    const nextDate = new Date(today);
    
    switch (frequency) {
      case 'weekly':
        nextDate.setDate(today.getDate() + 7);
        break;
      case 'bi-weekly':
        nextDate.setDate(today.getDate() + 14);
        break;
      case 'monthly':
        nextDate.setMonth(today.getMonth() + 1);
        nextDate.setDate(autoPaymentSettings.paymentDay);
        break;
    }
    
    return nextDate.toISOString();
  };

  const linkToExpense = async (payment: SalaryPayment): Promise<string> => {
    try {
      // Get existing expenses from localStorage
      const expensesData = localStorage.getItem('financeExpenses');
      const expenses = expensesData ? JSON.parse(expensesData) : [];
      
      // Create expense record
      const expense = {
        id: `expense-${Date.now()}`,
        category: 'Salaries',
        description: `Salary: ${payment.employeeName} - ${payment.period}`,
        amount: payment.amount,
        date: payment.paymentDate,
        paymentMethod: payment.paymentMethod === 'bank-transfer' ? 'Bank Transfer' : 
                       payment.paymentMethod === 'cash' ? 'Cash' : 'Check',
        receipt: null,
        linkedSalaryPayment: payment.id,
        tags: ['salary', 'payroll', 'employee'],
        recurring: false,
        status: payment.status === 'paid' ? 'paid' : 'pending'
      };

      // Save to expenses
      expenses.push(expense);
      localStorage.setItem('financeExpenses', JSON.stringify(expenses));

      return expense.id;
    } catch (error) {
      console.error('Error linking to expense:', error);
      return '';
    }
  };

  const processSalaryPayment = async (employeeId: string, notes?: string) => {
    const employee = employees.find(e => e.id === employeeId);
    if (!employee || !employee.salary) {
      alert('âŒ Employee salary not configured');
      return;
    }

    // Create salary payment record
    const payment: SalaryPayment = {
      id: `payment-${Date.now()}`,
      employeeId: employee.id,
      employeeName: employee.name,
      amount: employee.salary,
      paymentDate: new Date().toISOString(),
      period: new Date().toLocaleString('default', { month: 'long', year: 'numeric' }),
      status: autoPaymentSettings.requireApproval ? 'pending' : 'paid',
      paymentMethod: 'bank-transfer',
      notes: notes || `Monthly salary payment for ${employee.name}`
    };

    // Link to expense tracking
    const expenseId = await linkToExpense(payment);
    payment.expenseId = expenseId;

    if (autoPaymentSettings.requireApproval) {
      // Add to pending payments
      setPendingPayments([...pendingPayments, payment]);
      alert(`ðŸ’° Salary payment for ${employee.name} is pending approval`);
    } else {
      // Process immediately
      setSalaryPayments([...salaryPayments, payment]);
      alert(`âœ… Salary payment processed for ${employee.name}: R${employee.salary.toLocaleString()}`);
    }
    
    // Calculate next payment date
    if (employee.autoPayEnabled && employee.salaryFrequency) {
      const nextDate = calculateNextPaymentDate(employee.salaryFrequency);
      setEmployees(employees.map(e => 
        e.id === employeeId ? { ...e, nextPaymentDate: nextDate } : e
      ));
    }

    // Save to localStorage
    localStorage.setItem('productivitySalaryPayments', JSON.stringify([...salaryPayments, payment]));
  };

  const approvePendingPayment = async (paymentId: string) => {
    const payment = pendingPayments.find(p => p.id === paymentId);
    if (!payment) return;

    // Update payment status
    const approvedPayment = { ...payment, status: 'paid' as const };
    
    // Link to expense if not already linked
    if (!approvedPayment.expenseId) {
      const expenseId = await linkToExpense(approvedPayment);
      approvedPayment.expenseId = expenseId;
    }
    
    setSalaryPayments([...salaryPayments, approvedPayment]);
    setPendingPayments(pendingPayments.filter(p => p.id !== paymentId));
    
    // Save to localStorage
    localStorage.setItem('productivitySalaryPayments', JSON.stringify([...salaryPayments, approvedPayment]));
    localStorage.setItem('productivityPendingPayments', JSON.stringify(pendingPayments.filter(p => p.id !== paymentId)));
    
    alert(`âœ… Payment approved for ${payment.employeeName}: R${payment.amount.toLocaleString()}`);
  };

  const rejectPendingPayment = (paymentId: string, reason: string) => {
    const payment = pendingPayments.find(p => p.id === paymentId);
    if (!payment) return;

    setPendingPayments(pendingPayments.filter(p => p.id !== paymentId));
    localStorage.setItem('productivityPendingPayments', JSON.stringify(pendingPayments.filter(p => p.id !== paymentId)));
    
    alert(`âŒ Payment rejected for ${payment.employeeName}${reason ? ': ' + reason : ''}`);
  };

  const scheduleAutoPayments = () => {
    if (!autoPaymentSettings.enabled) return;

    const today = new Date();
    const currentDay = today.getDate();
    const currentMonth = today.toLocaleString('default', { month: 'long', year: 'numeric' });

    // Check if today is payment day
    if (currentDay !== autoPaymentSettings.paymentDay) return;

    // Check if already paid this month
    const thisMonthPayments = salaryPayments.filter(p => p.period === currentMonth);
    
    employees.forEach(employee => {
      if (!employee.autoPayEnabled || !employee.salary) return;
      if (employee.salaryFrequency !== 'monthly') return; // Only process monthly for now
      
      // Check if already paid this month
      const alreadyPaid = thisMonthPayments.some(p => 
        p.employeeId === employee.id && (p.status === 'paid' || p.status === 'pending')
      );
      if (alreadyPaid) return;

      // Process payment
      processSalaryPayment(employee.id, 'Automated monthly salary payment');
    });
  };

  // Check for automated payments daily
  useEffect(() => {
    if (autoPaymentSettings.enabled) {
      scheduleAutoPayments();
    }
  }, [autoPaymentSettings.enabled]); // Run when settings change or on mount
  
  const filteredEmployees = employees.filter(emp => 
    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    emp.role.toLowerCase().includes(searchTerm.toLowerCase()) ||
    emp.email.toLowerCase().includes(searchTerm.toLowerCase())
  );

  // LEGACY FUNCTION STUBS
  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600 bg-red-100 dark:bg-red-900/30';
      case 'medium': return 'text-yellow-600 bg-yellow-100 dark:bg-yellow-900/30';
      case 'low': return 'text-green-600 bg-green-100 dark:bg-green-900/30';
      default: return 'text-gray-600 bg-gray-100 dark:bg-gray-700';
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'text-green-600 bg-green-100 dark:bg-green-900/30';
      case 'in-progress': return 'text-blue-600 bg-blue-100 dark:bg-blue-900/30';
      case 'overdue': return 'text-red-600 bg-red-100 dark:bg-red-900/30';
      case 'pending': return 'text-gray-600 bg-gray-100 dark:bg-gray-700';
      default: return 'text-gray-600 bg-gray-100 dark:bg-gray-700';
    }
  };

  const getWellnessColor = (wellness: number) => {
    if (wellness >= 80) return 'text-green-600';
    if (wellness >= 60) return 'text-yellow-600';
    return 'text-red-600';
  };

  const toggleTaskExpansion = (taskId: string) => {
    const newExpanded = new Set(expandedTasks);
    if (newExpanded.has(taskId)) {
      newExpanded.delete(taskId);
    } else {
      newExpanded.add(taskId);
    }
    setExpandedTasks(newExpanded);
  };

  const toggleStageCompletion = (taskId: string, stageId: string, employeeId: string) => {
    // Legacy stub
  };

  const handleFileUpload = async (taskId: string, stageId: string, file: File) => {
    // Legacy stub
  };

  const downloadFile = (fileName: string, fileData: string) => {
    const link = document.createElement('a');
    link.href = fileData;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const addAssetToTask = () => {
    // Legacy stub
  };

  const calculateTaskProgress = (task: any): number => {
    return 0; // Legacy stub
  };

  const getTeamPerformance = () => {
    const teamStats: { [key: string]: { completed: number; inProgress: number; pending: number } } = {};
    
    employees.forEach(emp => {
      if (emp.team) {
        if (!teamStats[emp.team]) {
          teamStats[emp.team] = { completed: 0, inProgress: 0, pending: 0 };
        }
        teamStats[emp.team].completed += emp.tasksCompleted;
        teamStats[emp.team].inProgress += emp.tasksInProgress;
        teamStats[emp.team].pending += emp.tasksPending;
      }
    });
    
    return teamStats;
  };

  const calculateFinancials = () => {
    return { totalBudget: 0, totalSpent: 0, estimatedHours: 0, actualHours: 0 };
  };

  const saveEmployeeFinanceProfile = () => {
    const key = currentUserMeta.email || currentUserMeta.id;
    if (!key) {
      alert('Unable to save finance profile: no active employee account found.');
      return;
    }

    const grossSalary = parseFloat(employeeFinanceDraft.grossSalary) || 0;
    const netSalary = parseFloat(employeeFinanceDraft.netSalary) || 0;
    const monthlyExpenses = parseFloat(employeeFinanceDraft.monthlyExpenses) || 0;
    const emergencyFundTarget = parseFloat(employeeFinanceDraft.emergencyFundTarget) || 0;

    if (grossSalary <= 0 || netSalary <= 0) {
      alert('Please enter valid gross and net salary values.');
      return;
    }

    const profile: EmployeeFinanceProfile = {
      key,
      employeeId: currentUserMeta.id,
      email: currentUserMeta.email,
      grossSalary,
      netSalary,
      paymentFrequency: employeeFinanceDraft.paymentFrequency,
      monthlyExpenses,
      emergencyFundTarget,
      allowOwnerView: employeeFinanceDraft.allowOwnerView,
      updatedAt: new Date().toISOString(),
    };

    setEmployeeFinanceProfiles((prev) => ({
      ...prev,
      [key]: profile,
    }));

    alert('Employee finance profile saved.');
  };

  const getEmployeeFinanceForOwner = (employee: Employee): EmployeeFinanceProfile | null => {
    const byEmail = employeeFinanceProfiles[String(employee.email || '').trim().toLowerCase()];
    const byId = employeeFinanceProfiles[String(employee.id || '').trim().toLowerCase()];
    const profile = byEmail || byId || null;
    if (!profile || !profile.allowOwnerView) return null;
    return profile;
  };

  const scrollToAnchor = useCallback((anchorId?: string) => {
    if (!anchorId || typeof window === 'undefined') return;
    requestAnimationFrame(() => {
      const element = document.getElementById(anchorId);
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });
  }, []);

  const handleDeckNavigation = useCallback(
    (view: DeckView, options?: { modal?: DeckModal; scrollTo?: string }) => {
      setActiveView(view);
      scrollToAnchor(options?.scrollTo ?? VIEW_IDS[view]);

      if (!options?.modal) return;
      if (typeof window === 'undefined') {
        return;
      }

      requestAnimationFrame(() => {
        switch (options.modal) {
          case 'outcome':
            setShowOutcomeModal(true);
            break;
          case 'task':
            setShowTaskModal(true);
            break;
          case 'employee':
            setShowEmployeeModal(true);
            break;
          case 'team':
            setShowTeamModal(true);
            break;
          case 'wellness':
            setShowWellnessModal(true);
            break;
        }
      });
    },
    [scrollToAnchor, setActiveView, setShowOutcomeModal, setShowTaskModal, setShowEmployeeModal, setShowTeamModal, setShowWellnessModal]
  );

  const focusCount = (dailyFocus ? [dailyFocus.priority1, dailyFocus.priority2, dailyFocus.priority3].filter(Boolean).length : 0);
  const activeOutcomesTotal = outcomes.filter((outcome) => outcome.status === 'active').length;
  const pendingPayrollCount = pendingPayments.length;
  const openTasksCount = tasks.length;
  const employeeCount = employees.length;
  const teamCount = teams.length;
  const clockedInCount = employees.filter((emp) => getTodayClockStatus(emp.id)?.status === 'clocked-in').length;

  const navTabs = useMemo<Array<{ id: DeckView; label: string; icon: ComponentType<{ className?: string }>; badge?: number }>>(
    () => [
      { id: 'daily-os', label: 'Daily Orders', icon: Target, badge: focusCount || undefined },
      { id: 'outcomes', label: 'Outcome Queue', icon: Star, badge: activeOutcomesTotal || undefined },
      { id: 'performance', label: 'Performance Pulse', icon: BarChart2 },
      { id: 'salaries', label: 'Payroll Control', icon: DollarSign, badge: pendingPayrollCount || undefined },
      { id: 'autopilot', label: 'Autopilot Rules', icon: Sparkles },
      { id: 'legacy', label: 'Legacy View', icon: Users }
    ],
    [focusCount, activeOutcomesTotal, pendingPayrollCount]
  );

  const commandDeckCards = useMemo<CommandDeckCard[]>(() => [
    {
      id: 'daily-os',
      title: 'Daily Orders',
      description: 'Lock the run sheet and clear the three active orders.',
      icon: Target,
      accent: 'from-blue-600 to-indigo-600',
      metric: focusCount ? `${focusCount}/3 locked` : 'Needs signal',
      badge: focusMode ? 'Focus' : undefined,
      modal: focusCount === 0 ? 'outcome' : undefined,
    },
    {
      id: 'outcomes',
      title: 'Outcome Queue',
      description: 'Load, prioritize, and approve AI-generated tasks.',
      icon: Star,
      accent: 'from-purple-600 to-pink-600',
      metric: `${activeOutcomesTotal} active`,
      modal: 'outcome',
    },
    {
      id: 'performance',
      title: 'Performance Pulse',
      description: 'Check efficiency, burnout risk, and incentives.',
      icon: BarChart2,
      accent: 'from-indigo-500 to-violet-600',
      metric: `${performanceMetrics.weeklyEfficiency}% efficiency`,
    },
    {
      id: 'salaries',
      title: 'Payroll Control',
      description: 'Approve payouts and monitor auto-pay health.',
      icon: DollarSign,
      accent: 'from-emerald-500 to-green-600',
      metric: pendingPayrollCount ? `${pendingPayrollCount} approvals` : 'All clear',
    },
    {
      id: 'autopilot',
      title: 'Autopilot Rules',
      description: 'Tune AI enforcement across outcomes and focus.',
      icon: Sparkles,
      accent: 'from-pink-500 to-rose-500',
      metric: autopilotMode ? 'Autopilot ON' : 'Autopilot OFF',
    },
    {
      id: 'legacy',
      title: 'Legacy Dashboard',
      description: 'Classic boards for employees, tasks, and teams.',
      icon: Users,
      accent: 'from-slate-500 to-slate-700',
      metric: `${employeeCount} operators`,
    },
    {
      id: 'tasks',
      title: 'Task Backlog',
      description: 'Expand, assign, and audit every task stage.',
      icon: CheckSquare,
      accent: 'from-orange-500 to-amber-500',
      metric: `${openTasksCount} tasks`,
      modal: openTasksCount === 0 ? 'task' : undefined,
    },
    {
      id: 'employees',
      title: 'Employee Ops',
      description: 'Open wellness tabs and operator finance.',
      icon: UserCheck,
      accent: 'from-cyan-500 to-blue-600',
      metric: `${employeeCount} teammates`,
      modal: employeeCount === 0 ? 'employee' : undefined,
    },
    {
      id: 'teams',
      title: 'Team Boards',
      description: 'Review team pressure, meetings, and assets.',
      icon: Users,
      accent: 'from-fuchsia-500 to-purple-600',
      metric: `${teamCount} squads`,
      modal: teamCount === 0 ? 'team' : undefined,
    },
    {
      id: 'time-tracking',
      title: 'Time Tracking',
      description: 'Clock-in enforcement plus geo-audits.',
      icon: Timer,
      accent: 'from-teal-500 to-emerald-500',
      metric: `${clockedInCount} clocked in`,
    },
    {
      id: 'analytics',
      title: 'Analytics HQ',
      description: 'Budget, variance, and performance overlays.',
      icon: TrendingUp,
      accent: 'from-yellow-500 to-orange-600',
      metric: `${clockEntries.length} signals logged`,
    },
  ], [
    activeOutcomesTotal,
    autopilotMode,
    clockEntries.length,
    clockedInCount,
    employeeCount,
    focusCount,
    focusMode,
    openTasksCount,
    pendingPayrollCount,
    performanceMetrics.weeklyEfficiency,
    teamCount,
  ]);

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-900 p-4">
      <div className="max-w-7xl mx-auto">
        {/* HEADER WITH AUTOPILOT TOGGLE */}
        <div className="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 text-white rounded-2xl p-6 mb-6 shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-32 -mt-32"></div>
          <div className="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full -ml-24 -mb-24"></div>
          
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <h1 className="text-3xl font-bold flex items-center gap-3">
                <Brain className="w-10 h-10" />
                Outcome Command Deck
              </h1>
              
              <div className="flex items-center gap-3">
                <div className="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2 flex items-center gap-2">
                  <span className="text-sm font-medium">Autopilot Enforcement</span>
                  <button
                    onClick={() => setAutopilotMode(!autopilotMode)}
                    className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors ${
                      autopilotMode ? 'bg-green-500' : 'bg-gray-400'
                    }`}
                  >
                    <span className={`inline-block w-4 h-4 transform transition-transform bg-white rounded-full ${
                      autopilotMode ? 'translate-x-6' : 'translate-x-1'
                    }`} />
                  </button>
                </div>
                
                <button
                  onClick={() => handleDeckNavigation('employees', { modal: 'wellness' })}
                  className="bg-white/20 backdrop-blur-sm hover:bg-white/30 transition-all px-4 py-2 rounded-lg flex items-center gap-2"
                >
                  <Battery className="w-5 h-5" />
                  <span className="text-sm font-medium">
                    Energy: {wellnessData.currentEnergy}
                  </span>
                </button>
              </div>
            </div>
            
            <p className="text-white/90 text-lg">
              AI enforces outcomesâ€”feed it signal and move â€¢ 
              {performanceMetrics.burnoutRisk > 70 && <span className="text-yellow-300 ml-2">âš ï¸ High burnout risk detected</span>}
            </p>
            
            <div className="mt-4 flex items-center gap-4 text-sm">
              <div className="flex items-center gap-2">
                <TrendingUp className="w-4 h-4" />
                <span>Role: {userRole.type}</span>
              </div>
              <div className="flex items-center gap-2">
                <Sparkles className="w-4 h-4" />
                <span>{outcomes.filter(o => o.status === 'active').length} Active Outcomes</span>
              </div>
              <div className="flex items-center gap-2">
                <DollarSign className="w-4 h-4" />
                <span>R{performanceMetrics.revenueRealized.toLocaleString()} Realized</span>
              </div>
            </div>
          </div>
        </div>

        {/* NAVIGATION TABS */}
        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg mb-6 p-2 flex gap-2 overflow-x-auto">
          {navTabs.map((tab) => (
            <button
              key={tab.id}
              type="button"
              onClick={() => handleDeckNavigation(tab.id)}
              className={`flex items-center gap-2 px-4 py-2.5 rounded-lg font-semibold transition-all relative ${
                activeView === tab.id
                  ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg scale-105'
                  : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'
              }`}
            >
              <tab.icon className="w-5 h-5" />
              {tab.label}
              {typeof tab.badge === 'number' && tab.badge > 0 && (
                <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">
                  {tab.badge}
                </span>
              )}
            </button>
          ))}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
          {commandDeckCards.map((card) => (
            <button
              key={card.id}
              type="button"
              onClick={() => handleDeckNavigation(card.id, { modal: card.modal })}
              className={`text-left rounded-2xl p-5 bg-gradient-to-br ${card.accent} text-white shadow-lg hover:shadow-2xl hover:scale-[1.02] transition-all focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70`}
            >
              <div className="flex items-center justify-between mb-4">
                <card.icon className="w-6 h-6 opacity-90" />
                {card.badge && (
                  <span className="px-3 py-1 rounded-full text-xs font-bold bg-white/20 backdrop-blur-sm">
                    {card.badge}
                  </span>
                )}
              </div>
              <p className="text-sm uppercase tracking-wide text-white/80 mb-1">{card.metric}</p>
              <h3 className="text-xl font-bold mb-1">{card.title}</h3>
              <p className="text-sm text-white/80 mb-4">{card.description}</p>
              <span className="inline-flex items-center gap-1 text-sm font-semibold">
                Open view
                <ArrowRight className="w-4 h-4" />
              </span>
            </button>
          ))}
        </div>

        {/* =============================================*/}
        {/* ðŸŽ¯ DAILY OPERATING SYSTEM VIEW               */}
        {/* =============================================*/}
        {activeView === 'daily-os' && (
          <div className="space-y-6" id={VIEW_IDS['daily-os']}>
            {/* TODAY'S FOCUS - MAX 3 PRIORITIES */}
            <div className="bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-2xl p-6 border-2 border-blue-200 dark:border-blue-800">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                  <Target className="w-8 h-8 text-blue-600" />
                  Today's Orders
                  <span className="text-sm font-normal text-gray-600 dark:text-gray-400">
                    ({dailyFocus?.date || new Date().toLocaleDateString()})
                  </span>
                </h2>
                
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setFocusMode(!focusMode)}
                    className={`px-4 py-2 rounded-lg font-semibold transition-all flex items-center gap-2 ${
                      focusMode 
                        ? 'bg-red-600 text-white hover:bg-red-700' 
                        : 'bg-purple-600 text-white hover:bg-purple-700'
                    }`}
                  >
                    {focusMode ? <Square className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                    {focusMode ? 'Unlock Focus' : 'Lock Focus'}
                  </button>
                  
                  <button
                    onClick={generateDailyFocus}
                    className="px-4 py-2 bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-lg font-semibold hover:scale-105 transition-all shadow-md flex items-center gap-2"
                  >
                    <Sparkles className="w-4 h-4" />
                    Refresh Priorities
                  </button>
                </div>
              </div>

              {!dailyFocus || (!dailyFocus.priority1 && !dailyFocus.priority2 && !dailyFocus.priority3) ? (
                <div className="text-center py-12">
                  <Brain className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                  <p className="text-gray-600 dark:text-gray-400 text-lg mb-4">
                    No orders yet. Load outcomes so the AI can spit out the next three moves.
                  </p>
                  <button
                    onClick={() => handleDeckNavigation('outcomes', { modal: 'outcome' })}
                    className="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all"
                  >
                    Push First Outcome
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  {[dailyFocus.priority1, dailyFocus.priority2, dailyFocus.priority3].map((task, index) => {
                    if (!task) return null;
                    const outcome = outcomes.find(o => o.id === task.outcomeId);
                    
                    return (
                      <div
                        key={task.id}
                        className="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-lg border-2 border-transparent hover:border-blue-500 transition-all group"
                      >
                        <div className="flex items-start gap-4">
                          <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl font-bold text-white ${
                            index === 0 ? 'bg-gradient-to-br from-yellow-500 to-orange-500' :
                            index === 1 ? 'bg-gradient-to-br from-blue-500 to-purple-500' :
                            'bg-gradient-to-br from-green-500 to-teal-500'
                          }`}>
                            {index + 1}
                          </div>
                          
                          <div className="flex-1">
                            <div className="flex items-start justify-between mb-2">
                              <div>
                                <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-1">
                                  {task.title}
                                </h3>
                                <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                  {task.description}
                                </p>
                                {outcome && (
                                  <div className="flex items-center gap-2 text-sm">
                                    <span className="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded font-medium">
                                      {outcome.title}
                                    </span>
                                    <span className="text-gray-500">â€¢</span>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      R{outcome.revenueImpact.toLocaleString()} impact
                                    </span>
                                  </div>
                                )}
                              </div>
                              
                              <div className="flex flex-col items-end gap-2">
                                <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                  task.energyRequired === 'high' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' :
                                  task.energyRequired === 'medium' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' :
                                  'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
                                }`}>
                                  {task.energyRequired} energy
                                </span>
                                <div className="flex items-center gap-2 text-sm font-semibold text-purple-600 dark:text-purple-400">
                                  <Star className="w-4 h-4 fill-current" />
                                  {task.valueScore} value
                                </div>
                              </div>
                            </div>
                            
                            <div className="flex items-center gap-3 mt-4">
                              <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                                <Clock className="w-4 h-4" />
                                <span>{task.estimatedMinutes} min</span>
                              </div>
                              
                              {task.status === 'pending' && (
                                <button
                                  onClick={() => startTask(task.id)}
                                  className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all flex items-center gap-2"
                                >
                                  <Play className="w-4 h-4" />
                                  Start
                                </button>
                              )}
                              
                              {task.status === 'in-progress' && (
                                <button
                                  onClick={() => {
                                    const minutes = prompt('How many minutes did you spend?', task.estimatedMinutes.toString());
                                    if (minutes) {
                                      completeTask(task.id, parseInt(minutes));
                                    }
                                  }}
                                  className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all flex items-center gap-2"
                                >
                                  <CheckCircle2 className="w-4 h-4" />
                                  Complete
                                </button>
                              )}
                              
                              {task.status === 'completed' && (
                                <div className="px-4 py-2 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg font-semibold flex items-center gap-2">
                                  <CheckCircle2 className="w-4 h-4" />
                                  Completed
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* DAILY STATS */}
              {dailyFocus && (dailyFocus.completedTasks > 0 || dailyFocus.totalMinutes > 0) && (
                <div className="mt-6 bg-white dark:bg-gray-800 rounded-xl p-4">
                  <h3 className="font-semibold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                    <Activity className="w-5 h-5" />
                    Today's Tally
                  </h3>
                  <div className="grid grid-cols-3 gap-4">
                    <div>
                      <p className="text-2xl font-bold text-blue-600">{dailyFocus.completedTasks}</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">Tasks Closed</p>
                    </div>
                    <div>
                      <p className="text-2xl font-bold text-purple-600">{dailyFocus.totalMinutes}</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">Minutes Logged</p>
                    </div>
                    <div>
                      <p className="text-2xl font-bold text-green-600">{dailyFocus.valueCreated}</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">Value Booked</p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* WELLNESS STATUS */}
            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <Heart className="w-6 h-6 text-red-500" />
                Operator Status
              </h3>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Current Output Level
                  </label>
                  <div className="flex gap-2">
                    {(['low', 'medium', 'high'] as const).map((level) => (
                      <button
                        key={level}
                        onClick={() => setWellnessData({ ...wellnessData, currentEnergy: level })}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-all ${
                          wellnessData.currentEnergy === level
                            ? level === 'low' ? 'bg-red-600 text-white' :
                              level === 'medium' ? 'bg-yellow-600 text-white' :
                              'bg-green-600 text-white'
                            : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'
                        }`}
                      >
                        {level}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Sleep Logged (hrs)
                  </label>
                  <input
                    type="number"
                    min="0"
                    max="12"
                    step="0.5"
                    value={wellnessData.sleepHours}
                    onChange={(e) => setWellnessData({ ...wellnessData, sleepHours: parseFloat(e.target.value) || 0 })}
                    className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                  />
                </div>
                
                <div>
                  <label className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 block">
                    Stress Signal (0-10)
                  </label>
                  <input
                    type="number"
                    min="0"
                    max="10"
                    value={wellnessData.stressLevel}
                    onChange={(e) => setWellnessData({ ...wellnessData, stressLevel: parseFloat(e.target.value) || 0 })}
                    className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-900 text-gray-900 dark:text-white"
                  />
                </div>
              </div>

              {/* BURNOUT WARNING */}
              {performanceMetrics.burnoutRisk > 70 && (
                <div className="mt-4 bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-800 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <AlertTriangle className="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" />
                    <div>
                      <h4 className="font-bold text-red-900 dark:text-red-300 mb-2">
                        âš ï¸ Burnout Alert ({performanceMetrics.burnoutRisk}%)
                      </h4>
                      <ul className="text-sm text-red-800 dark:text-red-400 space-y-1">
                        {wellnessData.burnoutIndicators.map((indicator, i) => (
                          <li key={i}>â€¢ {indicator}</li>
                        ))}
                      </ul>
                      <button
                        onClick={() => setWellnessData({
                          ...wellnessData,
                          lastBreak: new Date().toISOString()
                        })}
                        className="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700"
                      >
                        Force Break
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {currentUserMeta.userType === 'employee' && (
                <div className="mt-6 rounded-lg border-2 border-emerald-300 bg-emerald-50 p-4 dark:border-emerald-800 dark:bg-emerald-900/20">
                  <h4 className="mb-3 text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <DollarSign className="w-5 h-5 text-emerald-600" />
                    Employee Finance
                  </h4>
                  <p className="mb-4 text-sm text-gray-600 dark:text-gray-400">
                    Manage your salary health and choose whether the business owner can view this on your wellness profile.
                  </p>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                      <label className="text-xs font-semibold text-gray-600 dark:text-gray-400">Gross Salary</label>
                      <input
                        type="number"
                        value={employeeFinanceDraft.grossSalary}
                        onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, grossSalary: e.target.value })}
                        className="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                        placeholder="45000"
                      />
                    </div>
                    <div>
                      <label className="text-xs font-semibold text-gray-600 dark:text-gray-400">Net Salary</label>
                      <input
                        type="number"
                        value={employeeFinanceDraft.netSalary}
                        onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, netSalary: e.target.value })}
                        className="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                        placeholder="36000"
                      />
                    </div>
                    <div>
                      <label className="text-xs font-semibold text-gray-600 dark:text-gray-400">Monthly Expenses</label>
                      <input
                        type="number"
                        value={employeeFinanceDraft.monthlyExpenses}
                        onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, monthlyExpenses: e.target.value })}
                        className="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                        placeholder="18000"
                      />
                    </div>
                    <div>
                      <label className="text-xs font-semibold text-gray-600 dark:text-gray-400">Emergency Fund Target</label>
                      <input
                        type="number"
                        value={employeeFinanceDraft.emergencyFundTarget}
                        onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, emergencyFundTarget: e.target.value })}
                        className="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                        placeholder="120000"
                      />
                    </div>
                  </div>

                  <div className="mt-3">
                    <label className="text-xs font-semibold text-gray-600 dark:text-gray-400">Payment Frequency</label>
                    <select
                      value={employeeFinanceDraft.paymentFrequency}
                      onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, paymentFrequency: e.target.value as 'weekly' | 'bi-weekly' | 'monthly' })}
                      className="mt-1 w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 dark:border-gray-600 dark:bg-gray-900 dark:text-white"
                    >
                      <option value="weekly">Weekly</option>
                      <option value="bi-weekly">Bi-Weekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                  </div>

                  <label className="mt-3 flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                    <input
                      type="checkbox"
                      checked={employeeFinanceDraft.allowOwnerView}
                      onChange={(e) => setEmployeeFinanceDraft({ ...employeeFinanceDraft, allowOwnerView: e.target.checked })}
                    />
                    Allow owner to view this finance summary in employee wellness tab
                  </label>

                  <button
                    onClick={saveEmployeeFinanceProfile}
                    className="mt-4 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700"
                  >
                    Save Employee Finance
                  </button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* =============================================*/}
        {/* ðŸŽ¯ OUTCOMES VIEW                              */}
        {/* =============================================*/}
        {activeView === 'outcomes' && (
          <div className="space-y-6" id={VIEW_IDS['outcomes']}>
            <div className="flex items-center justify-between">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <Star className="w-8 h-8 text-yellow-500" />
                Active Outcomes
              </h2>
              <button
                onClick={() => handleDeckNavigation('outcomes', { modal: 'outcome' })}
                className="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold hover:scale-105 transition-all flex items-center gap-2 shadow-lg"
              >
                <Plus className="w-5 h-5" />
                Create Outcome
              </button>
            </div>

            {outcomes.length === 0 ? (
              <div className="bg-white dark:bg-gray-800 rounded-2xl p-12 text-center shadow-lg">
                <Target className="w-20 h-20 text-gray-400 mx-auto mb-4" />
                <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">
                  No Outcomes Loaded
                </h3>
                <p className="text-gray-600 dark:text-gray-400 mb-6 max-w-md mx-auto">
                  Feed the deck an outcome and it will spit back the tasks. No input means no orders.
                </p>
                <button
                  onClick={() => handleDeckNavigation('outcomes', { modal: 'outcome' })}
                  className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700"
                >
                  Create Outcome Now
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 gap-6">
                {outcomes.map((outcome) => (
                  <div
                    key={outcome.id}
                    className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg border-2 border-transparent hover:border-blue-500 transition-all"
                  >
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <h3 className="text-2xl font-bold text-gray-900 dark:text-white">
                            {outcome.title}
                          </h3>
                          <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                            outcome.priority === 1 ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' :
                            outcome.priority === 2 ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' :
                            'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
                          }`}>
                            Priority {outcome.priority}
                          </span>
                          <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                            outcome.status === 'active' ? 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300' :
                            outcome.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' :
                            'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'
                          }`}>
                            {outcome.status}
                          </span>
                        </div>
                        <p className="text-gray-600 dark:text-gray-400 mb-3">
                          {outcome.description}
                        </p>
                        <div className="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-lg p-4 mb-4">
                          <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            ðŸ“Š Expected Outcome:
                          </p>
                          <p className="text-lg font-bold text-gray-900 dark:text-white">
                            {outcome.outcome}
                          </p>
                        </div>
                        <div className="flex items-center gap-6 text-sm">
                          <div className="flex items-center gap-2">
                            <DollarSign className="w-5 h-5 text-green-600" />
                            <span className="font-bold text-gray-900 dark:text-white">
                              R{outcome.revenueImpact.toLocaleString()}
                            </span>
                            <span className="text-gray-500">impact</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Calendar className="w-5 h-5 text-blue-600" />
                            <span className="text-gray-600 dark:text-gray-400">
                              Due: {new Date(outcome.deadline).toLocaleDateString()}
                            </span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Activity className="w-5 h-5 text-purple-600" />
                            <span className="font-bold text-gray-900 dark:text-white">
                              {outcome.progress}%
                            </span>
                            <span className="text-gray-500">complete</span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex flex-col gap-2">
                        {outcome.status === 'active' && outcome.tasks.length === 0 && (
                          <button
                            onClick={() => generateTasksForOutcome(outcome.id)}
                            className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 flex items-center gap-2"
                          >
                            <Sparkles className="w-4 h-4" />
                            Generate Tasks
                          </button>
                        )}
                        {outcome.status === 'active' && outcome.progress >= 100 && (
                          <button
                            onClick={() => {
                              const revenue = prompt('Actual revenue generated?', outcome.revenueImpact.toString());
                              if (revenue) {
                                completeOutcome(outcome.id, parseFloat(revenue));
                              }
                            }}
                            className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
                          >
                            Mark Complete
                          </button>
                        )}
                      </div>
                    </div>

                    {/* PROGRESS BAR */}
                    <div className="mb-4">
                      <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                        <div
                          className="bg-gradient-to-r from-blue-600 to-purple-600 h-3 rounded-full transition-all"
                          style={{ width: `${outcome.progress}%` }}
                        ></div>
                      </div>
                    </div>

                    {/* TASKS LIST */}
                    {outcome.tasks.length > 0 && (
                      <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                            <CheckSquare className="w-5 h-5" />
                            Action Tasks ({outcome.tasks.filter(t => t.status === 'completed').length}/{outcome.tasks.length})
                          </h4>
                          <button
                            onClick={() => {
                              setSelectedOutcome(outcome);
                              setShowTaskModal(true);
                            }}
                            className="text-sm px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded font-medium hover:bg-gray-200 dark:hover:bg-gray-600"
                          >
                            + Add Manual Task
                          </button>
                        </div>
                        <div className="space-y-2">
                          {outcome.tasks.map((task) => (
                            <div
                              key={task.id}
                              className={`p-3 rounded-lg border-2 ${
                                task.status === 'completed' ? 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-800' :
                                task.status === 'in-progress' ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-300 dark:border-blue-800' :
                                'bg-gray-50 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600'
                              }`}
                            >
                              <div className="flex items-center justify-between">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1">
                                    <h5 className="font-semibold text-gray-900 dark:text-white">
                                      {task.title}
                                    </h5>
                                    {task.autoGenerated && (
                                      <span className="px-2 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-xs font-bold rounded">
                                        AI
                                      </span>
                                    )}
                                  </div>
                                  <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                    {task.description}
                                  </p>
                                  <div className="flex items-center gap-4 text-xs">
                                    <span className={`px-2 py-0.5 rounded font-semibold ${
                                      task.energyRequired === 'high' ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' :
                                      task.energyRequired === 'medium' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' :
                                      'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300'
                                    }`}>
                                      {task.energyRequired} energy
                                    </span>
                                    <span className="text-gray-600 dark:text-gray-400">
                                      {task.estimatedMinutes} min
                                    </span>
                                    <span className="text-purple-600 dark:text-purple-400 font-semibold">
                                      â­ {task.valueScore}
                                    </span>
                                  </div>
                                </div>
                                <div className="flex items-center gap-2">
                                  {task.status === 'pending' && (
                                    <button
                                      onClick={() => startTask(task.id)}
                                      className="px-3 py-1.5 bg-blue-600 text-white rounded text-sm font-semibold hover:bg-blue-700"
                                    >
                                      Start
                                    </button>
                                  )}
                                  {task.status === 'in-progress' && (
                                    <button
                                      onClick={() => {
                                        const minutes = prompt('Minutes spent?', task.estimatedMinutes.toString());
                                        if (minutes) {
                                          completeTask(task.id, parseInt(minutes));
                                        }
                                      }}
                                      className="px-3 py-1.5 bg-green-600 text-white rounded text-sm font-semibold hover:bg-green-700"
                                    >
                                      Complete
                                    </button>
                                  )}
                                  {task.status === 'completed' && (
                                    <div className="px-3 py-1.5 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded text-sm font-semibold">
                                      âœ“ Done
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

         {/* =============================================*/}
        {/* ðŸ“Š PERFORMANCE VIEW                           */}
        {/* =============================================*/}
        {activeView === 'performance' && (
          <div className="space-y-6" id={VIEW_IDS['performance']}>
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <BarChart2 className="w-8 h-8 text-blue-600" />
              Performance Analytics
            </h2>

            {/* KEY METRICS */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-sm font-medium opacity-90">Weekly Efficiency</p>
                  <TrendingUp className="w-6 h-6 opacity-75" />
                </div>
                <p className="text-4xl font-bold">{performanceMetrics.weeklyEfficiency}</p>
                <p className="text-xs opacity-75 mt-1">Value per hour</p>
              </div>

              <div className="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-sm font-medium opacity-90">Completion Rate</p>
                  <CheckCircle2 className="w-6 h-6 opacity-75" />
                </div>
                <p className="text-4xl font-bold">{performanceMetrics.outcomeCompletionRate}%</p>
                <p className="text-xs opacity-75 mt-1">Outcomes delivered on time</p>
              </div>

              <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-sm font-medium opacity-90">Energy Match</p>
                  <Battery className="w-6 h-6 opacity-75" />
                </div>
                <p className="text-4xl font-bold">{performanceMetrics.energyOptimization}%</p>
                <p className="text-xs opacity-75 mt-1">Tasks aligned with energy</p>
              </div>

              <div className="bg-gradient-to-br from-yellow-500 to-orange-500 text-white rounded-xl p-6 shadow-lg">
                <div className="flex items-center justify-between mb-2">
                  <p className="text-sm font-medium opacity-90">Revenue Realized</p>
                  <DollarSign className="w-6 h-6 opacity-75" />
                </div>
                <p className="text-3xl font-bold">R{(performanceMetrics.revenueRealized / 1000).toFixed(0)}k</p>
                <p className="text-xs opacity-75 mt-1">From completed outcomes</p>
              </div>
            </div>

            {/* BURNOUT RISK GAUGE */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <Flame className="w-6 h-6 text-orange-500" />
                Burnout Risk Assessment
              </h3>
              <div className="relative">
                <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-6">
                  <div
                    className={`h-6 rounded-full transition-all ${
                      performanceMetrics.burnoutRisk < 30 ? 'bg-green-500' :
                      performanceMetrics.burnoutRisk < 70 ? 'bg-yellow-500' :
                      'bg-red-500'
                    }`}
                    style={{ width: `${performanceMetrics.burnoutRisk}%` }}
                  ></div>
                </div>
                <p className="text-center mt-2 text-2xl font-bold text-gray-900 dark:text-white">
                  {performanceMetrics.burnoutRisk}% Risk
                </p>
              </div>
              {wellnessData.burnoutIndicators.length > 0 && (
                <div className="mt-4 bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                  <p className="font-semibold text-red-900 dark:text-red-300 mb-2">Indicators:</p>
                  <ul className="space-y-1 text-sm text-red-800 dark:text-red-400">
                    {wellnessData.burnoutIndicators.map((indicator, i) => (
                      <li key={i}>â€¢ {indicator}</li>
                    ))}
                  </ul>
                </div>
              )}
            </div>

            {/* AI IMPROVEMENT SUGGESTIONS */}
            <div className="bg-gradient-to-br from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-2xl p-6 border-2 border-purple-200 dark:border-purple-800">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <Brain className="w-6 h-6 text-purple-600" />
                AI Improvement Suggestions
              </h3>
              {performanceMetrics.improvementSuggestions.length === 0 ? (
                <p className="text-gray-600 dark:text-gray-400">
                  Keep up the great work! Your productivity is optimized.
                </p>
              ) : (
                <div className="space-y-3">
                  {performanceMetrics.improvementSuggestions.map((suggestion, i) => (
                    <div key={i} className="flex items-start gap-3 p-3 bg-white dark:bg-gray-800 rounded-lg">
                      <Sparkles className="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5" />
                      <p className="text-gray-700 dark:text-gray-300">{suggestion}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* ROLE-SPECIFIC METRICS */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <UserCheck className="w-6 h-6 text-blue-600" />
                Role: {userRole.type.charAt(0).toUpperCase() + userRole.type.slice(1)}
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Tracking Metrics:</p>
                  <div className="space-y-2">
                    {userRole.metrics.map((metric, i) => (
                      <div key={i} className="flex items-center gap-2 text-gray-600 dark:text-gray-400">
                        <CheckCircle2 className="w-4 h-4 text-green-600" />
                        {metric}
                      </div>
                    ))}
                  </div>
                </div>
                <div>
                  <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Key Incentives:</p>
                  <div className="space-y-2">
                    {userRole.incentives.map((incentive, i) => (
                      <div key={i} className="flex items-center gap-2 text-gray-600 dark:text-gray-400">
                        <Star className="w-4 h-4 text-yellow-600" />
                        {incentive}
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* =============================================*/}
        {/* ðŸ’° SALARIES VIEW                             */}
        {/* =============================================*/}
        {activeView === 'salaries' && (
          <div className="space-y-6" id={VIEW_IDS['salaries']}>
            <div className="flex items-center justify-between">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                <DollarSign className="w-8 h-8 text-green-600" />
                Salary Management
              </h2>
              <button
                onClick={() => {
                  setAutoPaymentSettings({
                    ...autoPaymentSettings,
                    enabled: !autoPaymentSettings.enabled
                  });
                }}
                className={`px-4 py-2 rounded-lg font-semibold ${
                  autoPaymentSettings.enabled
                    ? 'bg-green-600 text-white'
                    : 'bg-gray-300 text-gray-700'
                }`}
              >
                {autoPaymentSettings.enabled ? 'âœ… Auto-Pay: ON' : 'â¸ï¸ Auto-Pay: OFF'}
              </button>
            </div>

            {/* Pending Payments */}
            {pendingPayments.length > 0 && (
              <div className="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-400 rounded-2xl p-6">
                <h3 className="text-xl font-bold text-yellow-900 dark:text-yellow-200 mb-4 flex items-center gap-2">
                  <AlertTriangle className="w-6 h-6" />
                  Pending Payments Require Approval ({pendingPayments.length})
                </h3>
                <div className="space-y-3">
                  {pendingPayments.map(payment => (
                    <div key={payment.id} className="bg-white dark:bg-gray-800 rounded-lg p-4 flex items-center justify-between">
                      <div>
                        <p className="font-bold text-gray-900 dark:text-white">{payment.employeeName}</p>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                          R{payment.amount.toLocaleString()} â€¢ {payment.period}
                        </p>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => approvePendingPayment(payment.id)}
                          className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold"
                        >
                          âœ… Approve & Pay
                        </button>
                        <button
                          onClick={() => setPendingPayments(pendingPayments.filter(p => p.id !== payment.id))}
                          className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold"
                        >
                          âŒ Reject
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Employees with Salary Info */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Employees & Salaries</h3>
              <div className="space-y-4">
                {employees.map(employee => (
                  <div key={employee.id} className="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        <AvatarImage
                          name={employee.name}
                          email={employee.email}
                          src={employee.profilePicture}
                          size="lg"
                          className="shadow-md"
                        />
                        <div>
                          <p className="font-bold text-gray-900 dark:text-white">{employee.name}</p>
                          <p className="text-sm text-gray-600 dark:text-gray-400">{employee.role}</p>
                          {employee.salary && (
                            <div className="flex items-center gap-2 mt-1">
                              <span className="text-lg font-bold text-green-600">
                                R{employee.salary.toLocaleString()}
                              </span>
                              <span className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                                {employee.salaryFrequency || 'monthly'}
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                      <div className="flex flex-col items-end gap-2">
                        {employee.nextPaymentDate && (
                          <div className="text-sm text-gray-600 dark:text-gray-400">
                            Next: {new Date(employee.nextPaymentDate).toLocaleDateString()}
                          </div>
                        )}
                        {employee.autoPayEnabled && (
                          <span className="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">
                            Auto-Pay ON
                          </span>
                        )}
                        {employee.salary && (
                          <button
                            onClick={() => {
                              if (confirm(`Pay ${employee.name} R${employee.salary?.toLocaleString()} now?`)) {
                                processSalaryPayment(employee.id, 'Manual payment');
                              }
                            }}
                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold text-sm"
                          >
                            ðŸ’³ Pay Now
                          </button>
                        )}
                      </div>
                    </div>
                    {employee.bankDetails && (
                      <div className="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600 text-sm">
                        <p className="text-gray-600 dark:text-gray-400">
                          <span className="font-semibold">Bank:</span> {employee.bankDetails.bank} â€¢ 
                          <span className="font-semibold"> Account:</span> {employee.bankDetails.accountNumber}
                        </p>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>

            {/* Payment History */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Payment History</h3>
              {salaryPayments.length === 0 ? (
                <div className="text-center py-12">
                  <DollarSign className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500 dark:text-gray-400">No salary payments recorded yet</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {salaryPayments
                    .sort((a, b) => new Date(b.paymentDate).getTime() - new Date(a.paymentDate).getTime())
                    .map(payment => (
                      <div key={payment.id} className="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 flex items-center justify-between">
                        <div>
                          <p className="font-bold text-gray-900 dark:text-white">{payment.employeeName}</p>
                          <p className="text-sm text-gray-600 dark:text-gray-400">
                            {payment.period} â€¢ {new Date(payment.paymentDate).toLocaleDateString()}
                          </p>
                          {payment.notes && (
                            <p className="text-xs text-gray-500 dark:text-gray-500 mt-1">{payment.notes}</p>
                          )}
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <p className="text-lg font-bold text-green-600">R{payment.amount.toLocaleString()}</p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">{payment.paymentMethod}</p>
                          </div>
                          {payment.status === 'paid' && (
                            <CheckCircle2 className="w-6 h-6 text-green-600" />
                          )}
                          {payment.expenseId && (
                            <span className="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">
                              Expense Recorded
                            </span>
                          )}
                        </div>
                      </div>
                    ))}
                </div>
              )}
            </div>

            {/* Auto-Payment Settings */}
            <div className="bg-gradient-to-r from-green-600 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
              <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                <Sparkles className="w-6 h-6" />
                Auto-Payment Configuration
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">Payment Day (Monthly)</label>
                  <input
                    type="number"
                    min="1"
                    max="31"
                    value={autoPaymentSettings.paymentDay}
                    onChange={(e) => setAutoPaymentSettings({
                      ...autoPaymentSettings,
                      paymentDay: parseInt(e.target.value) || 1
                    })}
                    className="w-full px-4 py-2 rounded-lg bg-white/20 backdrop-blur-sm border-2 border-white/30 text-white placeholder-white/70 font-semibold"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-2">Notification Days Before</label>
                  <input
                    type="number"
                    min="0"
                    max="14"
                    value={autoPaymentSettings.notificationDays}
                    onChange={(e) => setAutoPaymentSettings({
                      ...autoPaymentSettings,
                      notificationDays: parseInt(e.target.value) || 0
                    })}
                    className="w-full px-4 py-2 rounded-lg bg-white/20 backdrop-blur-sm border-2 border-white/30 text-white placeholder-white/70 font-semibold"
                  />
                </div>
              </div>
              <div className="mt-4 space-y-3">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={autoPaymentSettings.notifyBeforePayment}
                    onChange={(e) => setAutoPaymentSettings({
                      ...autoPaymentSettings,
                      notifyBeforePayment: e.target.checked
                    })}
                    className="w-5 h-5 rounded"
                  />
                  <span className="font-semibold">Send notification before payment</span>
                </label>
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={autoPaymentSettings.requireApproval}
                    onChange={(e) => setAutoPaymentSettings({
                      ...autoPaymentSettings,
                      requireApproval: e.target.checked
                    })}
                    className="w-5 h-5 rounded"
                  />
                  <span className="font-semibold">Require manual approval before payment</span>
                </label>
              </div>
            </div>
          </div>
        )}

        {/* =============================================*/}
        {/* âš™ï¸ AUTOPILOT SETTINGS VIEW                   */}
        {/* =============================================*/}
        {activeView === 'autopilot' && (
          <div className="space-y-6" id={VIEW_IDS['autopilot']}>
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
              <Sparkles className="w-8 h-8 text-purple-600" />
              Autopilot Mode Settings
            </h2>

            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <div className="flex items-center justify-between mb-6">
                <div>
                  <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-2">
                    Autopilot Mode
                  </h3>
                  <p className="text-gray-600 dark:text-gray-400">
                    Let AI automatically generate tasks, schedule your day, and optimize your workflow
                  </p>
                </div>
                <button
                  onClick={() => setAutopilotMode(!autopilotMode)}
                  className={`relative inline-flex items-center h-12 rounded-full w-24 transition-colors ${
                    autopilotMode ? 'bg-green-500' : 'bg-gray-400'
                  }`}
                >
                  <span className={`inline-block w-10 h-10 transform transition-transform bg-white rounded-full ${
                    autopilotMode ? 'translate-x-13' : 'translate-x-1'
                  }`} />
                </button>
              </div>

              {autopilotMode && (
                <div className="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                  <div className="flex items-center gap-3 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <CheckCircle2 className="w-6 h-6 text-green-600" />
                    <div>
                      <p className="font-semibold text-gray-900 dark:text-white">Auto-Generate Tasks</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">
                        AI creates actionable tasks when you add new outcomes
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                    <CheckCircle2 className="w-6 h-6 text-blue-600" />
                    <div>
                      <p className="font-semibold text-gray-900 dark:text-white">Smart Daily Prioritization</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">
                        AI selects your top 3 priorities based on value, urgency, and energy levels
                      </p>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-3 p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                    <CheckCircle2 className="w-6 h-6 text-purple-600" />
                    <div>
                      <p className="font-semibold text-gray-900 dark:text-white">Burnout Protection</p>
                      <p className="text-sm text-gray-600 dark:text-gray-400">
                        Auto-reduces workload when burnout risk exceeds 70%
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* ROLE SELECTION */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
              <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4">
                Your Role
              </h3>
              <p className="text-gray-600 dark:text-gray-400 mb-4">
                Choose your primary role to get tailored metrics and incentives
              </p>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {(['individual', 'employee', 'creator', 'business'] as const).map((role) => (
                  <button
                    key={role}
                    onClick={() => setUserRole({
                      type: role,
                      metrics: role === 'individual' ? ['efficiency', 'value-created', 'energy-optimization'] :
role === 'employee' ? ['tasks-completed', 'team-contribution', 'skill-growth'] :
                               role === 'creator' ? ['content-output', 'engagement', 'revenue'] :
                               ['revenue', 'team-performance', 'outcome-delivery'],
                      incentives: role === 'individual' ? ['achievement', 'growth', 'balance'] :
                                  role === 'employee' ? ['recognition', 'career-growth', 'team-success'] :
                                  role === 'creator' ? ['audience-growth', 'creative-freedom', 'income'] :
                                  ['profit', 'scale', 'impact']
                    })}
                    className={`p-4 rounded-xl font-semibold transition-all ${
                      userRole.type === role
                        ? 'bg-gradient-to-br from-blue-600 to-purple-600 text-white shadow-lg scale-105'
                        : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:scale-105'
                    }`}
                  >
                    {role.charAt(0).toUpperCase() + role.slice(1)}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* LEGACY VIEW (unchanged old dashboard) */}
        {activeView === 'legacy' && (
          <div className="space-y-6" id={VIEW_IDS['legacy']}>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 dark:text-gray-400">Total Employees</p>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">{employees.length}</p>
                  </div>
                  <Users className="w-12 h-12 text-blue-600" />
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 dark:text-gray-400">Active Tasks</p>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">
                      {tasks.filter(t => t.status !== 'completed').length}
                    </p>
                  </div>
                  <CheckSquare className="w-12 h-12 text-green-600" />
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 dark:text-gray-400">Teams</p>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">{teams.length}</p>
                  </div>
                  <UserCheck className="w-12 h-12 text-purple-600" />
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm text-gray-600 dark:text-gray-400">Avg Wellness</p>
                    <p className="text-3xl font-bold text-gray-900 dark:text-white">
                      {employees.length > 0 
                        ? Math.round(employees.reduce((sum, emp) => sum + emp.wellness, 0) / employees.length)
                        : 0}%
                    </p>
                  </div>
                  <Heart className="w-12 h-12 text-red-600" />
                </div>
              </div>
            </div>

            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                  <Users className="w-6 h-6" />
                  Navigate by Photo & Name
                </h2>
                <button
                  onClick={() => handleDeckNavigation('employees', { modal: 'employee' })}
                  className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-lg"
                >
                  <Plus className="w-5 h-5" />
                  Add Employee
                </button>
              </div>

              <div className="mb-4">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="text"
                    placeholder="Search employees by name, role, or email..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white
                             focus:border-blue-500 focus:outline-none"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                {filteredEmployees.map(employee => (
                  <button
                    key={employee.id}
                    onClick={() => setSelectedEmployee(employee)}
                    className="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 
                             rounded-xl p-4 hover:shadow-2xl hover:scale-105 transition-all cursor-pointer
                             border-2 border-transparent hover:border-blue-500"
                  >
                    <div className="mb-3 flex justify-center">
                      <AvatarImage
                        name={employee.name}
                        email={employee.email}
                        src={employee.profilePicture}
                        size="lg"
                        className="shadow-lg"
                      />
                    </div>
                    <h3 className="font-bold text-sm text-gray-900 dark:text-white mb-1 truncate">
                      {employee.name}
                    </h3>
                    <p className="text-xs text-gray-600 dark:text-gray-400 mb-2 truncate">{employee.role}</p>
                    {employee.team && (
                      <span className="text-xs px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full">
                        {employee.team}
                      </span>
                    )}
                    <div className="flex items-center justify-center gap-1 mt-2">
                      <Heart className={`w-4 h-4 ${getWellnessColor(employee.wellness)}`} />
                      <span className={`text-sm font-bold ${getWellnessColor(employee.wellness)}`}>
                        {employee.wellness}%
                      </span>
                    </div>
                  </button>
                ))}
              </div>
            </div>

            {tasks.length > 0 && (
              <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                <h2 className="text-xl font-bold text-gray-900 dark:text-white mb-4">Recent Tasks</h2>
                <div className="space-y-3">
                  {tasks.slice(0, 5).map(task => {
                    const assignedEmployee = getEmployeeById(task.assignedTo);
                    return (
                      <div key={task.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 flex items-center gap-4">
                        <AvatarImage
                          name={assignedEmployee?.name}
                          email={assignedEmployee?.email}
                          src={assignedEmployee?.profilePicture}
                          size="sm"
                          className="shadow-sm"
                        />
                        <div className="flex-1">
                          <h3 className="font-semibold text-gray-900 dark:text-white">{task.title}</h3>
                          <div className="flex items-center gap-3 mt-2 text-sm text-gray-600 dark:text-gray-400">
                            <span>{assignedEmployee?.name}</span>
                            <span className="flex items-center gap-1">
                              <Clock className="w-4 h-4" />
                              {new Date(task.deadline).toLocaleDateString()}
                            </span>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getPriorityColor(task.priority)}`}>
                            {task.priority}
                          </span>
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(task.status)}`}>
                            {task.status}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        )}

        {activeView === 'tasks' && (
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow" id={VIEW_IDS['tasks']}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">All Tasks</h2>
              <button
                onClick={() => setShowTaskModal(true)}
                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold shadow-lg"
              >
                <Plus className="w-5 h-5" />
                Create Task
              </button>
            </div>

            <div className="space-y-4">
              {tasks.map(task => {
                const assignedEmployee = getEmployeeById(task.assignedTo);
                const progress = calculateTaskProgress(task);
                const isExpanded = expandedTasks.has(task.id);
                
                return (
                  <div key={task.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-5 border-l-4 border-blue-600">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <button
                            onClick={() => toggleTaskExpansion(task.id)}
                            className="hover:bg-gray-200 dark:hover:bg-gray-600 p-1 rounded"
                          >
                            {isExpanded ? <ChevronDown className="w-5 h-5" /> : <ChevronRight className="w-5 h-5" />}
                          </button>
                          <h3 className="text-lg font-bold text-gray-900 dark:text-white">{task.title}</h3>
                        </div>
                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">{task.description}</p>
                        
                        {/* Progress Bar */}
                        {task.stages.length > 0 && (
                          <div className="mb-3">
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-xs font-medium text-gray-600 dark:text-gray-400">Progress</span>
                              <span className="text-xs font-bold text-blue-600">{progress}%</span>
                            </div>
                            <div className="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2">
                              <div 
                                className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                style={{ width: `${progress}%` }}
                              />
                            </div>
                          </div>
                        )}
                        
                        <div className="flex items-center gap-4 text-sm flex-wrap">
                          <div className="flex items-center gap-2">
                            <AvatarImage
                              name={assignedEmployee?.name}
                              email={assignedEmployee?.email}
                              src={assignedEmployee?.profilePicture}
                              size="lg"
                              showBorder={false}
                              className="shadow"
                            />
                            <div>
                              <p className="font-semibold text-gray-900 dark:text-white">{assignedEmployee?.name}</p>
                              <p className="text-xs text-gray-500">{assignedEmployee?.role}</p>
                            </div>
                          </div>
                          <span className="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                            <Calendar className="w-4 h-4" />
                            Deadline: {new Date(task.deadline).toLocaleDateString()}
                          </span>
                          {task.stages.length > 0 && (
                            <span className="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                              <CheckSquare className="w-4 h-4" />
                              {task.stages.filter((s: any) => s.completed).length}/{task.stages.length} stages
                            </span>
                          )}
                          {task.assets.length > 0 && (
                            <span className="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                              <Paperclip className="w-4 h-4" />
                              {task.assets.length} assets
                            </span>
                          )}
                          {task.budget && (
                            <span className="flex items-center gap-1 text-gray-600 dark:text-gray-400">
                              <DollarSign className="w-4 h-4" />
                              R{task.budget}
                            </span>
                          )}
                        </div>
                      </div>
                      <div className="flex flex-col gap-2 items-end">
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${getPriorityColor(task.priority)}`}>
                          {task.priority}
                        </span>
                        <select
                          value={task.status}
                          onChange={(e) => updateTaskStatus(task.id, e.target.value as Task['status'])}
                          className={`px-3 py-1 rounded-full text-xs font-bold cursor-pointer ${getStatusColor(task.status)}
                                   border-2 border-transparent focus:border-blue-500 focus:outline-none`}
                        >
                          <option value="pending">Pending</option>
                          <option value="in-progress">In Progress</option>
                          <option value="completed">Completed</option>
                          <option value="overdue">Overdue</option>
                        </select>
                      </div>
                    </div>
                    
                    {/* Expanded Details */}
                    {isExpanded && (
                      <div className="mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
                        {/* Stages */}
                        {task.stages.length > 0 && (
                          <div className="mb-4">
                            <h4 className="text-sm font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                              <Zap className="w-4 h-4" />
                              Task Stages
                            </h4>
                            <div className="space-y-2">
                              {task.stages.map((stage: any) => (
                                <div key={stage.id} className="bg-white dark:bg-gray-800 p-3 rounded-lg border-2 border-gray-200 dark:border-gray-700">
                                  <div className="flex items-start gap-3">
                                    <input
                                      type="checkbox"
                                      checked={stage.completed}
                                      onChange={() => toggleStageCompletion(task.id, stage.id, assignedEmployee?.id || '')}
                                      className="w-5 h-5 cursor-pointer mt-1"
                                    />
                                    <div className="flex-1">
                                      <p className={`text-sm font-medium mb-1 ${stage.completed ? 'line-through text-gray-500' : 'text-gray-900 dark:text-white'}`}>
                                        {stage.title}
                                      </p>
                                      {stage.completed && stage.completedAt && (
                                        <p className="text-xs text-gray-500 mb-2">
                                          Completed {new Date(stage.completedAt).toLocaleDateString()} by {assignedEmployee?.name}
                                        </p>
                                      )}
                                      
                                      {/* Evidence File Section */}
                                      {stage.evidenceFile ? (
                                        <div className="mt-2 flex items-center gap-2 bg-green-50 dark:bg-green-900/20 p-2 rounded">
                                          <Paperclip className="w-4 h-4 text-green-600" />
                                          <span className="text-xs text-green-700 dark:text-green-400 flex-1 truncate">
                                            {stage.evidenceFile.name} ({(stage.evidenceFile.size / 1024).toFixed(1)} KB)
                                          </span>
                                          <button
                                            onClick={() => downloadFile(stage.evidenceFile!.name, stage.evidenceFile!.data)}
                                            className="flex items-center gap-1 bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs font-medium"
                                          >
                                            <Download className="w-3 h-3" />
                                            Download
                                          </button>
                                        </div>
                                      ) : !stage.completed && (
                                        <div className="mt-2">
                                          <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={(e) => {
                                              const file = e.target.files?.[0];
                                              if (file) {
                                                handleFileUpload(task.id, stage.id, file);
                                              }
                                            }}
                                            className="hidden"
                                            id={`file-${stage.id}`}
                                          />
                                          <label
                                            htmlFor={`file-${stage.id}`}
                                            className="flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-3 py-1 rounded text-xs font-medium cursor-pointer"
                                          >
                                            <Upload className="w-3 h-3" />
                                            Upload Evidence
                                          </label>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                        
                        {/* Assets */}
                        {task.assets.length > 0 && (
                          <div className="mb-4">
                            <h4 className="text-sm font-bold text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                              <Paperclip className="w-4 h-4" />
                              Task Assets
                            </h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                              {task.assets.map((asset: any) => {
                                const AssetIcon = asset.type === 'note' ? FileText :
                                                 asset.type === 'image' ? ImageIcon :
                                                 asset.type === 'video' ? Video :
                                                 asset.type === 'file' ? Paperclip :
                                                 asset.type === 'document' ? FileText : Link2;
                                return (
                                  <div key={asset.id} className="flex items-center gap-2 bg-white dark:bg-gray-800 p-3 rounded">
                                    <AssetIcon className="w-5 h-5 text-blue-600" />
                                    <div className="flex-1 min-w-0">
                                      <p className="text-sm font-medium text-gray-900 dark:text-white truncate">{asset.title}</p>
                                      <p className="text-xs text-gray-500">
                                        {new Date(asset.addedAt).toLocaleDateString()}
                                        {asset.fileData && ` â€¢ ${(asset.fileData.size / 1024).toFixed(1)} KB`}
                                      </p>
                                    </div>
                                    {asset.type === 'file' && asset.fileData ? (
                                      <button
                                        onClick={() => downloadFile(asset.fileData!.name, asset.fileData!.data)}
                                        className="flex items-center gap-1 bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs font-medium"
                                      >
                                        <Download className="w-3 h-3" />
                                        Download
                                      </button>
                                    ) : asset.type !== 'note' && (
                                      <a 
                                        href={asset.content} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-blue-600 hover:text-blue-700 text-xs font-medium"
                                      >
                                        View
                                      </a>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                        
                        <button
                          onClick={() => {
                            setSelectedTask(task);
                            setShowAssetModal(true);
                          }}
                          className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold"
                        >
                          <Plus className="w-4 h-4" />
                          Add Asset
                        </button>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {activeView === 'employees' && (
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow" id={VIEW_IDS['employees']}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Employee Management</h2>
              <button
                onClick={() => setShowEmployeeModal(true)}
                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold shadow-lg"
              >
                <Plus className="w-5 h-5" />
                Add Employee
              </button>
            </div>

            <div className="grid gap-4">
              {employees.map(employee => (
                <div key={employee.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-5 hover:shadow-lg transition-all">
                  <div className="flex items-start gap-4">
                    <AvatarImage
                      name={employee.name}
                      email={employee.email}
                      src={employee.profilePicture}
                      size="xl"
                      showBorder={false}
                      className="shadow-lg flex-shrink-0"
                    />
                    <div className="flex-1">
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <h3 className="text-xl font-bold text-gray-900 dark:text-white">{employee.name}</h3>
                          <p className="text-sm text-gray-600 dark:text-gray-400">{employee.role}</p>
                          <p className="text-sm text-gray-500 dark:text-gray-500">{employee.email}</p>
                        </div>
                        {employee.team && (
                          <span className="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full text-sm font-medium">
                            {employee.team}
                          </span>
                        )}
                      </div>

                      <div className="mb-4">
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">Wellness Score</span>
                          <span className={`text-sm font-bold ${getWellnessColor(employee.wellness)}`}>
                            {employee.wellness}%
                          </span>
                        </div>
                        <div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                          <div
                            className={`h-3 rounded-full transition-all ${
                              employee.wellness >= 80 ? 'bg-green-600' :
                              employee.wellness >= 60 ? 'bg-yellow-600' : 'bg-red-600'
                            }`}
                            style={{ width: `${employee.wellness}%` }}
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-3 gap-4">
                        <div className="bg-white dark:bg-gray-600 rounded-lg p-3 text-center">
                          <p className="text-2xl font-bold text-green-600">{employee.tasksCompleted}</p>
                          <p className="text-xs text-gray-600 dark:text-gray-400">Completed</p>
                        </div>
                        <div className="bg-white dark:bg-gray-600 rounded-lg p-3 text-center">
                          <p className="text-2xl font-bold text-blue-600">{employee.tasksInProgress}</p>
                          <p className="text-xs text-gray-600 dark:text-gray-400">In Progress</p>
                        </div>
                        <div className="bg-white dark:bg-gray-600 rounded-lg p-3 text-center">
                          <p className="text-2xl font-bold text-yellow-600">{employee.tasksPending}</p>
                          <p className="text-xs text-gray-600 dark:text-gray-400">Pending</p>
                        </div>
                      </div>

                      <div className="mt-4 flex justify-end">
                        <button
                          onClick={() => setSelectedEmployee(employee)}
                          className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                        >
                          Open Wellness Tab
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeView === 'teams' && (
          <div className="space-y-6" id={VIEW_IDS['teams']}>
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Team Dashboards</h2>
                <button
                  onClick={() => setShowTeamModal(true)}
                  className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-bold shadow-lg"
                >
                  <Plus className="w-5 h-5" />
                  Create Team
                </button>
              </div>

              <div className="space-y-6">
                {teams.map(team => {
                  const members = getTeamMembers(team.name);
                  const teamTasks = tasks.filter(t => {
                    const assignedEmployee = employees.find(e => e.id === t.assignedTo);
                    return assignedEmployee && team.members.includes(assignedEmployee.id);
                  });
                  const completedTasks = teamTasks.filter(t => t.status === 'completed').length;
                  const totalTasks = teamTasks.length;
                  const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                  
                  // Calculate total hours worked by team this week
                  const teamHours = members.reduce((total, member) => {
                    return total + getTotalHoursWorked(member.id, 7);
                  }, 0);
                  
                  // Calculate efficiency (tasks completed per hour)
                  const efficiency = teamHours > 0 ? (completedTasks / teamHours).toFixed(2) : '0.00';
                  
                  return (
                    <div key={team.id} className="bg-gradient-to-br from-gray-50 to-white dark:from-gray-700 dark:to-gray-800 rounded-xl p-6 border-l-4 shadow-lg" style={{ borderColor: team.color }}>
                      {/* Team Header */}
                      <div className="flex items-center justify-between mb-6">
                        <div>
                          <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">{team.name}</h3>
                          <p className="text-sm text-gray-600 dark:text-gray-400">{members.length} members â€¢ {totalTasks} total projects</p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              setSelectedTeamForMeeting(team);
                              setShowMeetingModal(true);
                            }}
                            className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold shadow transition-all hover:scale-105"
                          >
                            <VideoIcon className="w-4 h-4" />
                            Schedule Meeting
                          </button>
                        </div>
                      </div>

                      {/* Key Metrics */}
                      <div className="grid grid-cols-4 gap-4 mb-6">
                        <div className="bg-white dark:bg-gray-900 rounded-lg p-4 text-center">
                          <div className="text-3xl font-bold text-purple-600">{completedTasks}/{totalTasks}</div>
                          <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">Projects Complete</div>
                        </div>
                        <div className="bg-white dark:bg-gray-900 rounded-lg p-4 text-center">
                          <div className="text-3xl font-bold text-green-600">{progressPercentage}%</div>
                          <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">Progress Rate</div>
                        </div>
                        <div className="bg-white dark:bg-gray-900 rounded-lg p-4 text-center">
                          <div className="text-3xl font-bold text-blue-600">{teamHours.toFixed(1)}h</div>
                          <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">Hours This Week</div>
                        </div>
                        <div className="bg-white dark:bg-gray-900 rounded-lg p-4 text-center">
                          <div className="text-3xl font-bold text-orange-600">{efficiency}</div>
                          <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">Tasks/Hour</div>
                        </div>
                      </div>

                      {/* Progress Bar */}
                      <div className="mb-6">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm font-semibold text-gray-900 dark:text-white">Overall Progress</span>
                          <span className="text-sm font-bold" style={{ color: team.color }}>{progressPercentage}%</span>
                        </div>
                        <div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                          <div className="h-full rounded-full transition-all" style={{ width: `${progressPercentage}%`, backgroundColor: team.color }}></div>
                        </div>
                      </div>

                      {/* Assigned Projects */}
                      <div className="mb-6">
                        <h4 className="text-sm font-bold text-gray-900 dark:text-white mb-3">ðŸ“‹ Assigned Projects</h4>
                        {teamTasks.length > 0 ? (
                          <div className="space-y-2">
                            {teamTasks.slice(0, 3).map(task => {
                              const assignedEmployee = employees.find(e => e.id === task.assignedTo);
                              return (
                                <div key={task.id} className="flex items-center justify-between bg-white dark:bg-gray-900 rounded-lg p-3">
                                  <div className="flex-1">
                                    <div className="font-semibold text-gray-900 dark:text-white text-sm">{task.title}</div>
                                    <div className="text-xs text-gray-600 dark:text-gray-400">Assigned to {assignedEmployee?.name}</div>
                                  </div>
                                  <span className={`px-2 py-1 rounded text-xs font-medium ${
                                    task.status === 'completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' :
                                    task.status === 'in-progress' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400' :
                                    'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400'
                                  }`}>
                                    {task.status}
                                  </span>
                                </div>
                              );
                            })}
                            {teamTasks.length > 3 && (
                              <div className="text-center text-sm text-gray-600 dark:text-gray-400 pt-2">
                                +{teamTasks.length - 3} more projects
                              </div>
                            )}
                          </div>
                        ) : (
                          <p className="text-center text-gray-400 py-4">No projects assigned yet</p>
                        )}
                      </div>

                      {/* Team Members */}
                      <div>
                        <h4 className="text-sm font-bold text-gray-900 dark:text-white mb-3">ðŸ‘¥ Team Members</h4>
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                          {members.map(member => {
                            const memberTasks = teamTasks.filter(t => t.assignedTo === member.id);
                            const memberCompleted = memberTasks.filter(t => t.status === 'completed').length;
                            const memberHours = getTotalHoursWorked(member.id, 7);
                            
                            return (
                              <div key={member.id} className="bg-white dark:bg-gray-900 rounded-lg p-3 hover:shadow-lg transition-all relative group">
                                <div className="relative mb-2 flex justify-center">
                                  <AvatarImage
                                    name={member.name}
                                    email={member.email}
                                    src={member.profilePicture}
                                    size="lg"
                                    showBorder={false}
                                    className="shadow"
                                  />
                                  <button
                                    onClick={() => {
                                      setUploadingEmployee(member);
                                      setShowProfileUploadModal(true);
                                    }}
                                    className="absolute top-0 right-0 bg-blue-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                    title="Upload Photo"
                                  >
                                    <Camera className="w-3 h-3" />
                                  </button>
                                </div>
                                <p className="text-sm font-semibold text-gray-900 dark:text-white text-center truncate">{member.name.split(' ')[0]}</p>
                                <p className="text-xs text-gray-500 dark:text-gray-400 text-center truncate mb-2">{member.role}</p>
                                <div className="text-xs text-center space-y-1">
                                  <div className="text-gray-600 dark:text-gray-400">{memberCompleted}/{memberTasks.length} tasks</div>
                                  <div className="text-blue-600 dark:text-blue-400 font-semibold">{memberHours.toFixed(1)}h worked</div>
                                </div>
                                <button
                                  onClick={() => {
                                    setMessageRecipient(member);
                                    setShowMessageModal(true);
                                  }}
                                  className="w-full mt-2 px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold flex items-center justify-center gap-1 transition-all"
                                >
                                  <MessageSquare className="w-3 h-3" />
                                  Message
                                </button>
                              </div>
                            );
                          })}
                        </div>

                        {members.length === 0 && (
                          <p className="text-center text-gray-400 py-8">No team members yet</p>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        )}

        {activeView === 'time-tracking' && (
          <div className="space-y-6" id={VIEW_IDS['time-tracking']}>
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                <Timer className="w-6 h-6" />
                Employee Time Tracking & Clock In/Out
              </h2>

              {locationError && (
                <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
                  <p className="text-red-800 dark:text-red-300 text-sm">{locationError}</p>
                </div>
              )}

              {/* Clock In/Out Cards for Each Employee */}
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                {employees.map(employee => {
                  const todayStatus = getTodayClockStatus(employee.id);
                  const weeklyHours = getTotalHoursWorked(employee.id, 7);
                  const isClockedIn = todayStatus?.status === 'clocked-in';

                  return (
                    <div key={employee.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 border-2 border-gray-200 dark:border-gray-600">
                      <div className="flex items-center gap-3 mb-4">
                        <AvatarImage
                          name={employee.name}
                          email={employee.email}
                          src={employee.profilePicture}
                          size="lg"
                          showBorder={false}
                        />
                        <div>
                          <h3 className="text-lg font-bold text-gray-900 dark:text-white">{employee.name}</h3>
                          <p className="text-sm text-gray-600 dark:text-gray-400">{employee.role}</p>
                        </div>
                      </div>

                      {/* Status Badge */}
                      <div className="mb-4">
                        {isClockedIn ? (
                          <div className="flex items-center gap-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-2 rounded-lg">
                            <Play className="w-4 h-4" />
                            <span className="text-sm font-semibold">Currently Clocked In</span>
                          </div>
                        ) : todayStatus?.status === 'clocked-out' ? (
                          <div className="flex items-center gap-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-3 py-2 rounded-lg">
                            <Square className="w-4 h-4" />
                            <span className="text-sm font-semibold">Clocked Out for Today</span>
                          </div>
                        ) : (
                          <div className="flex items-center gap-2 bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-lg">
                            <Clock className="w-4 h-4" />
                            <span className="text-sm font-semibold">Not Clocked In</span>
                          </div>
                        )}
                      </div>

                      {/* Today's Info */}
                      {todayStatus && (
                        <div className="space-y-2 mb-4 text-sm">
                          <div className="flex items-center justify-between">
                            <span className="text-gray-600 dark:text-gray-400">Clock In:</span>
                            <span className="font-semibold text-gray-900 dark:text-white">
                              {new Date(todayStatus.clockInTime).toLocaleTimeString()}
                            </span>
                          </div>
                          {todayStatus.clockOutTime && (
                            <>
                              <div className="flex items-center justify-between">
                                <span className="text-gray-600 dark:text-gray-400">Clock Out:</span>
                                <span className="font-semibold text-gray-900 dark:text-white">
                                  {new Date(todayStatus.clockOutTime).toLocaleTimeString()}
                                </span>
                              </div>
                              <div className="flex items-center justify-between">
                                <span className="text-gray-600 dark:text-gray-400">Hours Today:</span>
                                <span className="font-bold text-blue-600">{todayStatus.hoursWorked}h</span>
                              </div>
                            </>
                          )}
                          <div className="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400 pt-2 border-t border-gray-300 dark:border-gray-600">
                            <MapPin className="w-3 h-3" />
                            <span className="truncate">{todayStatus.clockInLocation.address.substring(0, 40)}...</span>
                          </div>
                        </div>
                      )}

                      {/* Weekly Summary */}
                      <div className="mb-4 bg-white dark:bg-gray-800 rounded-lg p-3">
                        <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">This Week (7 days)</p>
                        <p className="text-2xl font-bold text-gray-900 dark:text-white">{weeklyHours.toFixed(1)}h</p>
                      </div>

                      {/* Clock In/Out Buttons */}
                      <div className="flex gap-2">
                        {isClockedIn ? (
                          <button
                            onClick={() => clockOut(employee.id)}
                            disabled={isLoadingLocation}
                            className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                          >
                            <Square className="w-4 h-4" />
                            {isLoadingLocation ? 'Getting Location...' : 'Clock Out'}
                          </button>
                        ) : (
                          <button
                            onClick={() => clockIn(employee.id)}
                            disabled={isLoadingLocation || todayStatus?.status === 'clocked-out'}
                            className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                          >
                            <Play className="w-4 h-4" />
                            {isLoadingLocation ? 'Getting Location...' : 'Clock In'}
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Time Tracking History Table */}
              <div>
                <h3 className="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                  <Clock className="w-5 h-5" />
                  Time Tracking History (Last 30 Days)
                </h3>
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-gray-200 dark:bg-gray-600">
                      <tr>
                        <th className="text-left p-3 text-sm font-bold text-gray-900 dark:text-white">Employee</th>
                        <th className="text-left p-3 text-sm font-bold text-gray-900 dark:text-white">Date</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Clock In</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Clock Out</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Hours</th>
                        <th className="text-left p-3 text-sm font-bold text-gray-900 dark:text-white">Location</th>
                      </tr>
                    </thead>
                    <tbody>
                      {clockEntries
                        .sort((a, b) => new Date(b.clockInTime).getTime() - new Date(a.clockInTime).getTime())
                        .slice(0, 50)
                        .map(entry => {
                          const employee = employees.find(e => e.id === entry.employeeId);
                          return (
                            <tr key={entry.id} className="border-t border-gray-300 dark:border-gray-600">
                              <td className="p-3">
                                <div className="flex items-center gap-2">
                                  <AvatarImage
                                    name={employee?.name}
                                    email={employee?.email}
                                    src={employee?.profilePicture}
                                    size="sm"
                                    showBorder={false}
                                  />
                                  <div>
                                    <p className="text-sm font-semibold text-gray-900 dark:text-white">{employee?.name}</p>
                                    <p className="text-xs text-gray-500">{employee?.role}</p>
                                  </div>
                                </div>
                              </td>
                              <td className="p-3 text-sm text-gray-700 dark:text-gray-300">
                                {new Date(entry.clockInTime).toLocaleDateString()}
                              </td>
                              <td className="text-center p-3 text-sm text-gray-700 dark:text-gray-300">
                                {new Date(entry.clockInTime).toLocaleTimeString()}
                              </td>
                              <td className="text-center p-3 text-sm text-gray-700 dark:text-gray-300">
                                {entry.clockOutTime ? new Date(entry.clockOutTime).toLocaleTimeString() : '-'}
                              </td>
                              <td className="text-center p-3">
                                {entry.hoursWorked ? (
                                  <span className="inline-block bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-3 py-1 rounded-full text-sm font-bold">
                                    {entry.hoursWorked}h
                                  </span>
                                ) : (
                                  <span className="inline-block bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-bold">
                                    Working...
                                  </span>
                                )}
                              </td>
                              <td className="p-3 text-xs text-gray-500 dark:text-gray-400">
                                <div className="flex items-center gap-1">
                                  <MapPin className="w-3 h-3" />
                                  <span className="truncate max-w-xs">{entry.clockInLocation.address}</span>
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                    </tbody>
                  </table>
                  {clockEntries.length === 0 && (
                    <div className="text-center py-12 text-gray-500 dark:text-gray-400">
                      <Clock className="w-12 h-12 mx-auto mb-3 opacity-50" />
                      <p>No time tracking data yet. Employees can clock in to start tracking.</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Summary Stats */}
              <div className="grid md:grid-cols-4 gap-4 mt-8">
                <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                  <p className="text-sm text-gray-600 dark:text-gray-400">Total Employees</p>
                  <p className="text-2xl font-bold text-blue-600">{employees.length}</p>
                </div>
                <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                  <p className="text-sm text-gray-600 dark:text-gray-400">Clocked In Today</p>
                  <p className="text-2xl font-bold text-green-600">
                    {employees.filter(emp => {
                      const status = getTodayClockStatus(emp.id);
                      return status?.status === 'clocked-in';
                    }).length}
                  </p>
                </div>
                <div className="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4">
                  <p className="text-sm text-gray-600 dark:text-gray-400">Total Hours (This Week)</p>
                  <p className="text-2xl font-bold text-purple-600">
                    {employees.reduce((sum, emp) => sum + getTotalHoursWorked(emp.id, 7), 0).toFixed(1)}h
                  </p>
                </div>
                <div className="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4">
                  <p className="text-sm text-gray-600 dark:text-gray-400">Total Entries</p>
                  <p className="text-2xl font-bold text-orange-600">{clockEntries.length}</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeView === 'analytics' && (
          <div className="space-y-6" id={VIEW_IDS['analytics']}>
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                <TrendingUp className="w-6 h-6" />
                Performance Analytics & Financial Tracking
              </h2>

              {/* Financial Overview */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                {(() => {
                  const { totalBudget, totalSpent, estimatedHours, actualHours } = calculateFinancials();
                  const budgetVariance = totalBudget - totalSpent;
                  const hoursVariance = estimatedHours - actualHours;
                  
                  return (
                    <>
                      <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <p className="text-sm text-gray-600 dark:text-gray-400">Total Budget</p>
                        <p className="text-2xl font-bold text-blue-600">R{totalBudget.toFixed(2)}</p>
                      </div>
                      <div className="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                        <p className="text-sm text-gray-600 dark:text-gray-400">Total Spent</p>
                        <p className="text-2xl font-bold text-red-600">R{totalSpent.toFixed(2)}</p>
                      </div>
                      <div className={`rounded-lg p-4 ${budgetVariance >= 0 ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}`}>
                        <p className="text-sm text-gray-600 dark:text-gray-400">Budget Variance</p>
                        <p className={`text-2xl font-bold ${budgetVariance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          R{budgetVariance.toFixed(2)}
                        </p>
                      </div>
                      <div className="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4">
                        <p className="text-sm text-gray-600 dark:text-gray-400">Est. vs Actual Hours</p>
                        <p className="text-2xl font-bold text-purple-600">{estimatedHours}h / {actualHours}h</p>
                      </div>
                    </>
                  );
                })()}
              </div>

              {/* Task Completion Rate */}
              <div className="mb-6">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                  <CheckSquare className="w-5 h-5" />
                  Task Completion Rate
                </h3>
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  {(() => {
                    const completedTasks = tasks.filter(t => t.status === 'completed').length;
                    const totalTasks = tasks.length;
                    const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                    
                    return (
                      <>
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-sm font-medium text-gray-700 dark:text-gray-300">
                            {completedTasks} of {totalTasks} tasks completed
                          </span>
                          <span className="text-sm font-bold text-blue-600">{completionRate}%</span>
                        </div>
                        <div className="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-4">
                          <div 
                            className="bg-green-600 h-4 rounded-full transition-all duration-300"
                            style={{ width: `${completionRate}%` }}
                          />
                        </div>
                      </>
                    );
                  })()}
                </div>
              </div>

              {/* Employee Performance */}
              <div className="mb-6">
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                  <Activity className="w-5 h-5" />
                  Employee Performance
                </h3>
                <div className="bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-gray-200 dark:bg-gray-600">
                      <tr>
                        <th className="text-left p-3 text-sm font-bold text-gray-900 dark:text-white">Employee</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Completed</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">In Progress</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Pending</th>
                        <th className="text-center p-3 text-sm font-bold text-gray-900 dark:text-white">Wellness</th>
                      </tr>
                    </thead>
                    <tbody>
                      {employees.map(emp => (
                        <tr key={emp.id} className="border-t border-gray-300 dark:border-gray-600">
                          <td className="p-3">
                            <div className="flex items-center gap-2">
                              <AvatarImage
                                name={emp.name}
                                email={emp.email}
                                src={emp.profilePicture}
                                size="sm"
                                showBorder={false}
                              />
                              <div>
                                <p className="text-sm font-semibold text-gray-900 dark:text-white">{emp.name}</p>
                                <p className="text-xs text-gray-500">{emp.role}</p>
                              </div>
                            </div>
                          </td>
                          <td className="text-center p-3">
                            <span className="inline-block bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1 rounded-full text-sm font-bold">
                              {emp.tasksCompleted}
                            </span>
                          </td>
                          <td className="text-center p-3">
                            <span className="inline-block bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 px-3 py-1 rounded-full text-sm font-bold">
                              {emp.tasksInProgress}
                            </span>
                          </td>
                          <td className="text-center p-3">
                            <span className="inline-block bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 px-3 py-1 rounded-full text-sm font-bold">
                              {emp.tasksPending}
                            </span>
                          </td>
                          <td className="text-center p-3">
                            <span className={`text-sm font-bold ${getWellnessColor(emp.wellness)}`}>
                              {emp.wellness}%
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Team Performance */}
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                  <UserCheck className="w-5 h-5" />
                  Team Performance
                </h3>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {(() => {
                    const teamStats = getTeamPerformance();
                    return Object.entries(teamStats).map(([teamName, stats]) => {
                      const team = teams.find(t => t.name === teamName);
                      const totalTasks = stats.completed + stats.inProgress + stats.pending;
                      
                      return (
                        <div key={teamName} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border-l-4" style={{ borderColor: team?.color || '#3b82f6' }}>
                          <h4 className="text-lg font-bold text-gray-900 dark:text-white mb-3">{teamName}</h4>
                          <div className="space-y-2">
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-gray-600 dark:text-gray-400">Total Tasks</span>
                              <span className="text-sm font-bold text-gray-900 dark:text-white">{totalTasks}</span>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-gray-600 dark:text-gray-400">Completed</span>
                              <span className="text-sm font-bold text-green-600">{stats.completed}</span>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-gray-600 dark:text-gray-400">In Progress</span>
                              <span className="text-sm font-bold text-blue-600">{stats.inProgress}</span>
                            </div>
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-gray-600 dark:text-gray-400">Pending</span>
                              <span className="text-sm font-bold text-yellow-600">{stats.pending}</span>
                            </div>
                          </div>
                        </div>
                      );
                    });
                  })()}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* =============================================*/}
        {/* ðŸŽ¯ CREATE OUTCOME MODAL                       */}
        {/* =============================================*/}
        {showOutcomeModal && (
          <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                  <Star className="w-8 h-8 text-yellow-500" />
                  Create Outcome
                </h2>
                <button 
                  onClick={() => setShowOutcomeModal(false)} 
                  className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="space-y-5">
                <div>
                  <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                    Outcome Title *
                  </label>
                  <input
                    type="text"
                    value={newOutcome.title}
                    onChange={(e) => setNewOutcome({ ...newOutcome, title: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none text-lg font-semibold"
                    placeholder="e.g., Launch New Product Line"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                    Description
                  </label>
                  <textarea
                    value={newOutcome.description}
                    onChange={(e) => setNewOutcome({ ...newOutcome, description: e.target.value })}
                    rows={2}
                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Brief description of the project or goal"
                  />
                </div>

                <div className="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-xl p-4 border-2 border-green-200 dark:border-green-800">
                  <label className="block text-sm font-bold text-gray-900 dark:text-white mb-2">
                    ðŸ“Š Expected Outcome (What will be achieved?) *
                  </label>
                  <textarea
                    value={newOutcome.outcome}
                    onChange={(e) => setNewOutcome({ ...newOutcome, outcome: e.target.value })}
                    rows={3}
                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Generate R500,000 in first-quarter revenue with 200+ customers"
                  />
                  <p className="text-xs text-gray-600 dark:text-gray-400 mt-2">
                    ðŸ’¡ Be specific and measurable. This drives AI task generation.
                  </p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Priority *
                    </label>
                    <select
                      value={newOutcome.priority}
                      onChange={(e) => setNewOutcome({ ...newOutcome, priority: parseInt(e.target.value) as 1 | 2 | 3 })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    >
                      <option value={1}>ðŸ”´ Priority 1 - Critical</option>
                      <option value={2}>ðŸŸ¡ Priority 2 - High</option>
                      <option value={3}>ðŸŸ¢ Priority 3 - Medium</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Deadline *
                    </label>
                    <input
                      type="date"
                      value={newOutcome.deadline}
                      onChange={(e) => setNewOutcome({ ...newOutcome, deadline: e.target.value })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Revenue Impact (R)
                    </label>
                    <input
                      type="number"
                      value={newOutcome.revenueImpact}
                      onChange={(e) => setNewOutcome({ ...newOutcome, revenueImpact: e.target.value })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                      placeholder="0"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Owner
                    </label>
                    <input
                      type="text"
                      value={newOutcome.owner}
                      onChange={(e) => setNewOutcome({ ...newOutcome, owner: e.target.value })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                      placeholder="You"
                    />
                  </div>
                </div>

                {autopilotMode && (
                  <div className="bg-purple-50 dark:bg-purple-900/20 border-2 border-purple-300 dark:border-purple-800 rounded-xl p-4 flex items-start gap-3">
                    <Sparkles className="w-6 h-6 text-purple-600 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-semibold text-purple-900 dark:text-purple-300 mb-1">
                        Autopilot Enabled
                      </p>
                      <p className="text-sm text-purple-800 dark:text-purple-400">
                        AI will automatically generate actionable tasks for this outcome
                      </p>
                    </div>
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={createOutcome}
                    className="flex-1 px-6 py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:scale-105 transition-all shadow-lg"
                  >
                    âœ¨ Create Outcome
                  </button>
                  <button
                    onClick={() => setShowOutcomeModal(false)}
                    className="px-6 py-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* =============================================*/}
        {/* âž• ADD MANUAL TASK MODAL                      */}
        {/* =============================================*/}
        {showTaskModal && selectedOutcome && (
          <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-lg w-full shadow-2xl">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                  <Plus className="w-6 h-6" />
                  Add Manual Task
                </h2>
                <button 
                  onClick={() => setShowTaskModal(false)} 
                  className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
                >
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  Adding task to: <span className="font-bold text-gray-900 dark:text-white">{selectedOutcome.title}</span>
                </p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                    Task Title *
                  </label>
                  <input
                    type="text"
                    value={newManualTask.title}
                    onChange={(e) => setNewManualTask({ ...newManualTask, title: e.target.value })}
                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Review analytics dashboard"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                    Description
                  </label>
                  <textarea
                    value={newManualTask.description}
                    onChange={(e) => setNewManualTask({ ...newManualTask, description: e.target.value })}
                    rows={3}
                    className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Task details..."
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Estimated Minutes
                    </label>
                    <input
                      type="number"
                      value={newManualTask.estimatedMinutes}
                      onChange={(e) => setNewManualTask({ ...newManualTask, estimatedMinutes: e.target.value })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                      placeholder="30"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                      Energy Required
                    </label>
                    <select
                      value={newManualTask.energyRequired}
                      onChange={(e) => setNewManualTask({ ...newManualTask, energyRequired: e.target.value as 'low' | 'medium' | 'high' })}
                      className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    >
                      <option value="low">ðŸŸ¢ Low</option>
                      <option value="medium">ðŸŸ¡ Medium</option>
                      <option value="high">ðŸ”´ High</option>
                    </select>
                  </div>
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={addManualTask}
                    className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all"
                  >
                    Add Task
                  </button>
                  <button
                    onClick={() => setShowTaskModal(false)}
                    className="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl font-semibold hover:bg-gray-300 dark:hover:bg-gray-600"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* OLD TASK MODAL - KEEP FOR LEGACY VIEW */}
        {showTaskModal && !selectedOutcome && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full shadow-2xl">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Create New Task</h2>
                <button onClick={() => setShowTaskModal(false)} className="text-gray-500 hover:text-gray-700">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Task Title *
                  </label>
                  <input
                    type="text"
                    value={newTask.title}
                    onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Complete website redesign"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Description
                  </label>
                  <textarea
                    value={newTask.description}
                    onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}
                    rows={3}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Task details..."
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Assign to Employee *
                  </label>
                  <select
                    value={newTask.assignedTo}
                    onChange={(e) => setNewTask({ ...newTask, assignedTo: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                  >
                    <option value="">Select employee...</option>
                    {employees.map(emp => (
                      <option key={emp.id} value={emp.id}>
                        {emp.name} - {emp.role}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Deadline *
                    </label>
                    <input
                      type="date"
                      value={newTask.deadline}
                      onChange={(e) => setNewTask({ ...newTask, deadline: e.target.value })}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Priority
                    </label>
                    <select
                      value={newTask.priority}
                      onChange={(e) => setNewTask({ ...newTask, priority: e.target.value as any })}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    >
                      <option value="low">Low</option>
                      <option value="medium">Medium</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <Zap className="w-4 h-4 inline mr-1" />
                    Break Down into Stages (One per line)
                  </label>
                  <textarea
                    value={newTask.stagesList}
                    onChange={(e) => setNewTask({ ...newTask, stagesList: e.target.value })}
                    rows={4}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Research&#10;Design&#10;Development&#10;Testing&#10;Deployment"
                  />
                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Each stage will have a checkbox for tracking progress
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    <Target className="w-4 h-4 inline mr-1" />
                    Organizational Goal (Optional)
                  </label>
                  <select
                    value={newTask.organizationalGoal}
                    onChange={(e) => setNewTask({ ...newTask, organizationalGoal: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                  >
                    <option value="">None - Not linked to a goal</option>
                    <option value="revenue-growth">ðŸ’° Increase Revenue by 20%</option>
                    <option value="customer-acquisition">ðŸ‘¥ Acquire 1000 New Customers</option>
                    <option value="product-launch">ðŸš€ Launch New Product Line</option>
                    <option value="market-expansion">ðŸŒ Expand to New Markets</option>
                    <option value="team-growth">ðŸ‘¨â€ðŸ’¼ Grow Team by 50%</option>
                    <option value="efficiency">âš¡ Improve Operational Efficiency</option>
                  </select>
                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                    Link this task to organizational goals for performance tracking
                  </p>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      <DollarSign className="w-4 h-4 inline mr-1" />
                      Budget (R)
                    </label>
                    <input
                      type="number"
                      value={newTask.budget}
                      onChange={(e) => setNewTask({ ...newTask, budget: e.target.value })}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                      placeholder="0"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      <Clock className="w-4 h-4 inline mr-1" />
                      Est. Hours
                    </label>
                    <input
                      type="number"
                      value={newTask.estimatedHours}
                      onChange={(e) => setNewTask({ ...newTask, estimatedHours: e.target.value })}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                      placeholder="0"
                    />
                  </div>
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setShowTaskModal(false)}
                  className="flex-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500
                           text-gray-900 dark:text-white font-bold py-3 px-4 rounded-lg transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={createTask}
                  className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg
                           transition-all transform hover:scale-105 shadow-lg"
                >
                  Create Task
                </button>
              </div>
            </div>
          </div>
        )}

        {showEmployeeModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full shadow-2xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Add New Employee</h2>
                <button onClick={() => setShowEmployeeModal(false)} className="text-gray-500 hover:text-gray-700">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Profile Picture (Choose Emoji) *
                  </label>
                  <div className="grid grid-cols-8 gap-2 mb-3">
                    {['ðŸ‘¨â€ðŸ’¼', 'ðŸ‘©â€ðŸ’¼', 'ðŸ‘¨â€ðŸ’»', 'ðŸ‘©â€ðŸ’»', 'ðŸ‘¨â€ðŸ”§', 'ðŸ‘©â€ðŸ”§', 'ðŸ‘¨â€ðŸŽ¨', 'ðŸ‘©â€ðŸŽ¨', 'ðŸ‘¨â€ðŸ«', 'ðŸ‘©â€ðŸ«', 'ðŸ‘¨â€âš•ï¸', 'ðŸ‘©â€âš•ï¸', 'ðŸ‘¨â€ðŸ”¬', 'ðŸ‘©â€ðŸ”¬', 'ðŸ‘¨â€ðŸ³', 'ðŸ‘©â€ðŸ³'].map(emoji => (
                      <button
                        key={emoji}
                        onClick={() => setNewEmployee({ ...newEmployee, profilePicture: emoji })}
                        className={`text-3xl p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-all ${
                          newEmployee.profilePicture === emoji ? 'bg-blue-100 dark:bg-blue-900/30 ring-2 ring-blue-500' : ''
                        }`}
                      >
                        {emoji}
                      </button>
                    ))}
                  </div>
                  <input
                    type="text"
                    value={newEmployee.profilePicture}
                    onChange={(e) => setNewEmployee({ ...newEmployee, profilePicture: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="Or paste any emoji"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Full Name *
                  </label>
                  <input
                    type="text"
                    value={newEmployee.name}
                    onChange={(e) => setNewEmployee({ ...newEmployee, name: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., John Smith"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Email *
                  </label>
                  <input
                    type="email"
                    value={newEmployee.email}
                    onChange={(e) => setNewEmployee({ ...newEmployee, email: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="john@company.com"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Role *
                  </label>
                  <input
                    type="text"
                    value={newEmployee.role}
                    onChange={(e) => setNewEmployee({ ...newEmployee, role: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Developer, Designer, Manager"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Team (optional)
                  </label>
                  <select
                    value={newEmployee.team}
                    onChange={(e) => setNewEmployee({ ...newEmployee, team: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                  >
                    <option value="">No team</option>
                    {teams.map(team => (
                      <option key={team.id} value={team.name}>{team.name}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setShowEmployeeModal(false)}
                  className="flex-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500
                           text-gray-900 dark:text-white font-bold py-3 px-4 rounded-lg transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={addEmployee}
                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg
                           transition-all transform hover:scale-105 shadow-lg"
                >
                  Add Employee
                </button>
              </div>
            </div>
          </div>
        )}

        {showTeamModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Create New Team</h2>
                <button onClick={() => setShowTeamModal(false)} className="text-gray-500 hover:text-gray-700">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Team Name *
                  </label>
                  <input
                    type="text"
                    value={newTeam.name}
                    onChange={(e) => setNewTeam({ ...newTeam, name: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Development, Marketing, Sales"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Team Color
                  </label>
                  <div className="flex gap-2">
                    {['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'].map(color => (
                      <button
                        key={color}
                        onClick={() => setNewTeam({ ...newTeam, color })}
                        className={`w-12 h-12 rounded-lg transition-all ${newTeam.color === color ? 'ring-4 ring-offset-2 ring-gray-400' : ''}`}
                        style={{ backgroundColor: color }}
                      />
                    ))}
                  </div>
                </div>
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setShowTeamModal(false)}
                  className="flex-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500
                           text-gray-900 dark:text-white font-bold py-3 px-4 rounded-lg transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={createTeam}
                  className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg
                           transition-all transform hover:scale-105 shadow-lg"
                >
                  Create Team
                </button>
              </div>
            </div>
          </div>
        )}

        {selectedEmployee && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-start justify-between mb-6">
                <div className="flex items-center gap-4">
                  <AvatarImage
                    name={selectedEmployee.name}
                    email={selectedEmployee.email}
                    src={selectedEmployee.profilePicture}
                    size="xl"
                    showBorder={false}
                    className="shadow-2xl"
                  />
                  <div>
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white">{selectedEmployee.name}</h2>
                    <p className="text-gray-600 dark:text-gray-400">{selectedEmployee.role}</p>
                    <p className="text-sm text-gray-500 dark:text-gray-500">{selectedEmployee.email}</p>
                    {selectedEmployee.team && (
                      <span className="inline-block mt-2 px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full text-sm font-medium">
                        {selectedEmployee.team}
                      </span>
                    )}
                  </div>
                </div>
                <button onClick={() => setSelectedEmployee(null)} className="text-gray-500 hover:text-gray-700">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="mb-6">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                    <Heart className="w-5 h-5" />
                    Wellness Score
                  </span>
                  <span className={`text-2xl font-bold ${getWellnessColor(selectedEmployee.wellness)}`}>
                    {selectedEmployee.wellness}%
                  </span>
                </div>
                <div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-4">
                  <div
                    className={`h-4 rounded-full transition-all ${
                      selectedEmployee.wellness >= 80 ? 'bg-green-600' :
                      selectedEmployee.wellness >= 60 ? 'bg-yellow-600' : 'bg-red-600'
                    }`}
                    style={{ width: `${selectedEmployee.wellness}%` }}
                  />
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4 mb-6">
                <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                  <p className="text-3xl font-bold text-green-600">{selectedEmployee.tasksCompleted}</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">Completed Tasks</p>
                </div>
                <div className="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                  <p className="text-3xl font-bold text-blue-600">{selectedEmployee.tasksInProgress}</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">In Progress</p>
                </div>
                <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4 text-center">
                  <p className="text-3xl font-bold text-yellow-600">{selectedEmployee.tasksPending}</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">Pending</p>
                </div>
              </div>

              {currentUserMeta.userType === 'business' && (() => {
                const finance = getEmployeeFinanceForOwner(selectedEmployee);
                if (!finance) {
                  return (
                    <div className="mb-6 rounded-lg border border-gray-200 bg-gray-50 p-4 text-sm text-gray-600 dark:border-gray-700 dark:bg-gray-900/30 dark:text-gray-400">
                      Employee finance is not shared for this employee.
                    </div>
                  );
                }

                const discretionary = finance.netSalary - finance.monthlyExpenses;
                return (
                  <div className="mb-6 rounded-lg border-2 border-emerald-300 bg-emerald-50 p-4 dark:border-emerald-800 dark:bg-emerald-900/20">
                    <h3 className="mb-3 text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                      <DollarSign className="w-5 h-5 text-emerald-600" />
                      Employee Finance (Shared)
                    </h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                      <div className="rounded bg-white p-3 dark:bg-gray-800">
                        <p className="text-gray-500">Gross</p>
                        <p className="font-bold text-gray-900 dark:text-white">R{finance.grossSalary.toLocaleString()}</p>
                      </div>
                      <div className="rounded bg-white p-3 dark:bg-gray-800">
                        <p className="text-gray-500">Net</p>
                        <p className="font-bold text-gray-900 dark:text-white">R{finance.netSalary.toLocaleString()}</p>
                      </div>
                      <div className="rounded bg-white p-3 dark:bg-gray-800">
                        <p className="text-gray-500">Expenses</p>
                        <p className="font-bold text-gray-900 dark:text-white">R{finance.monthlyExpenses.toLocaleString()}</p>
                      </div>
                      <div className="rounded bg-white p-3 dark:bg-gray-800">
                        <p className="text-gray-500">Discretionary</p>
                        <p className={`font-bold ${discretionary >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          R{discretionary.toLocaleString()}
                        </p>
                      </div>
                    </div>
                    <p className="mt-3 text-xs text-gray-500 dark:text-gray-400">
                      Frequency: {finance.paymentFrequency} â€¢ Updated: {new Date(finance.updatedAt).toLocaleString()}
                    </p>
                  </div>
                );
              })()}

              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white mb-3">Assigned Tasks</h3>
                <div className="space-y-3 max-h-64 overflow-y-auto">
                  {tasks.filter(task => task.assignedTo === selectedEmployee.id).map(task => (
                    <div key={task.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                      <div className="flex items-start justify-between">
                        <div>
                          <h4 className="font-semibold text-gray-900 dark:text-white">{task.title}</h4>
                          <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">{task.description}</p>
                          <div className="flex items-center gap-3 mt-2 text-xs text-gray-500">
                            <span className="flex items-center gap-1">
                              <Calendar className="w-3 h-3" />
                              {new Date(task.deadline).toLocaleDateString()}
                            </span>
                          </div>
                        </div>
                        <div className="flex flex-col gap-1">
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPriorityColor(task.priority)}`}>
                            {task.priority}
                          </span>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(task.status)}`}>
                            {task.status}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                  {tasks.filter(task => task.assignedTo === selectedEmployee.id).length === 0 && (
                    <p className="text-center text-gray-400 py-4">No tasks assigned yet</p>
                  )}
                </div>
              </div>

              <button
                onClick={() => setSelectedEmployee(null)}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition-all"
              >
                Close
              </button>
            </div>
          </div>
        )}

        {showAssetModal && selectedTask && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full shadow-2xl">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-gray-900 dark:text-white">Add Asset to Task</h2>
                <button onClick={() => setShowAssetModal(false)} className="text-gray-500 hover:text-gray-700">
                  <X className="w-6 h-6" />
                </button>
              </div>

              <div className="mb-4 bg-gray-50 dark:bg-gray-700 rounded-lg p-3">
                <p className="text-sm font-semibold text-gray-900 dark:text-white">{selectedTask.title}</p>
                <p className="text-xs text-gray-500">Task ID: {selectedTask.id}</p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Asset Type *
                  </label>
                  <select
                    value={newAsset.type}
                    onChange={(e) => setNewAsset({ ...newAsset, type: e.target.value as any })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                  >
                    <option value="note">ðŸ“ Note</option>
                    <option value="image">ðŸ–¼ï¸ Image</option>
                    <option value="video">ðŸŽ¥ Video</option>
                    <option value="document">ðŸ“„ Document</option>
                    <option value="file">ðŸ“Ž File Upload</option>
                    <option value="link">ðŸ”— Link</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Asset Title *
                  </label>
                  <input
                    type="text"
                    value={newAsset.title}
                    onChange={(e) => setNewAsset({ ...newAsset, title: e.target.value })}
                    className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                             bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    placeholder="e.g., Research findings, Design mockup, Demo video"
                  />
                </div>

                {newAsset.type === 'file' ? (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Upload File *
                    </label>
                    <input
                      type="file"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) {
                          const reader = new FileReader();
                          reader.onloadend = () => {
                            setNewAsset({ 
                              ...newAsset, 
                              content: file.name,
                              title: newAsset.title || file.name
                            });
                            // Store file data temporarily
                            (window as any).tempFileData = {
                              name: file.name,
                              type: file.type,
                              data: reader.result as string,
                              size: file.size
                            };
                          };
                          reader.readAsDataURL(file);
                        }
                      }}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    />
                    {newAsset.content && (
                      <p className="text-xs text-gray-500 mt-2">
                        Selected: {newAsset.content}
                      </p>
                    )}
                  </div>
                ) : (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      {newAsset.type === 'note' ? 'Note Content *' : 'URL *'}
                    </label>
                    {newAsset.type === 'note' ? (
                      <textarea
                        value={newAsset.content}
                        onChange={(e) => setNewAsset({ ...newAsset, content: e.target.value })}
                        rows={4}
                        className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                                 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                        placeholder="Enter your notes here..."
                      />
                    ) : (
                      <input
                        type="url"
                        value={newAsset.content}
                        onChange={(e) => setNewAsset({ ...newAsset, content: e.target.value })}
                        className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                                 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                        placeholder="https://"
                      />
                    )}
                  </div>
                )}

                {'stages' in selectedTask && selectedTask.stages && selectedTask.stages.length > 0 && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Link to Stage (Optional)
                    </label>
                    <select
                      value={newAsset.stageId}
                      onChange={(e) => setNewAsset({ ...newAsset, stageId: e.target.value })}
                      className="w-full px-4 py-2 border-2 border-gray-300 dark:border-gray-600 rounded-lg
                               bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">None - General asset</option>
                      {selectedTask.stages.map(stage => (
                        <option key={stage.id} value={stage.id}>
                          {stage.completed ? 'âœ…' : 'â³'} {stage.name}
                        </option>
                      ))}
                    </select>
                  </div>
                )}
              </div>

              <div className="flex gap-3 mt-6">
                <button
                  onClick={() => setShowAssetModal(false)}
                  className="flex-1 bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500
                           text-gray-900 dark:text-white font-bold py-3 px-4 rounded-lg transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={addAssetToTask}
                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg
                           transition-all transform hover:scale-105 shadow-lg"
                >
                  Add Asset
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Quick Message Modal */}
        {showMessageModal && messageRecipient && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowMessageModal(false)}>
            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">ðŸ“¨ Quick Message</h2>
                <button onClick={() => setShowMessageModal(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="mb-4 bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex items-center gap-3">
                <AvatarImage
                  name={messageRecipient.name}
                  email={messageRecipient.email}
                  src={messageRecipient.profilePicture}
                  size="lg"
                  showBorder={false}
                  className="shadow"
                />
                <div>
                  <p className="font-semibold text-gray-900 dark:text-white">{messageRecipient.name}</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">{messageRecipient.role}</p>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                  Your Message
                </label>
                <textarea
                  value={messageText}
                  onChange={(e) => setMessageText(e.target.value)}
                  rows={5}
                  placeholder={`Send a message to ${messageRecipient.name}...`}
                  className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 resize-none"
                />
              </div>

              <div className="flex gap-3">
                <button
                  onClick={() => setShowMessageModal(false)}
                  className="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl font-semibold hover:scale-105 transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={() => {
                    if (messageText.trim()) {
                      alert(`Message sent to ${messageRecipient.name}!`);
                      setMessageText('');
                      setShowMessageModal(false);
                    }
                  }}
                  className="flex-1 px-4 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-xl font-semibold hover:scale-105 transition-all flex items-center justify-center gap-2"
                >
                  <Send className="w-4 h-4" />
                  Send Message
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Schedule Meeting Modal */}
        {showMeetingModal && selectedTeamForMeeting && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowMeetingModal(false)}>
            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">ðŸ“… Schedule Progress Meeting</h2>
                <button onClick={() => setShowMeetingModal(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="mb-6 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg p-4">
                <p className="font-semibold text-gray-900 dark:text-white mb-1">Team: {selectedTeamForMeeting.name}</p>
                <p className="text-sm text-gray-600 dark:text-gray-400">
                  {getTeamMembers(selectedTeamForMeeting.name).length} members will be invited
                </p>
              </div>

              <div className="space-y-3">
                <p className="text-sm font-semibold text-gray-900 dark:text-white mb-3">Quick Meeting Links:</p>
                
                <a
                  href="https://zoom.us/start/videomeeting"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl hover:scale-105 transition-all border-2 border-blue-200 dark:border-blue-700"
                >
                  <div className="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center">
                    <VideoIcon className="w-6 h-6 text-white" />
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold text-gray-900 dark:text-white">Start Zoom Meeting</div>
                    <div className="text-xs text-gray-600 dark:text-gray-400">Open Zoom and create instant meeting</div>
                  </div>
                  <ArrowRight className="w-5 h-5 text-gray-400" />
                </a>

                <a
                  href="https://teams.microsoft.com/l/meetup-join"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl hover:scale-105 transition-all border-2 border-purple-200 dark:border-purple-700"
                >
                  <div className="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                    <VideoIcon className="w-6 h-6 text-white" />
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold text-gray-900 dark:text-white">Start MS Teams Meeting</div>
                    <div className="text-xs text-gray-600 dark:text-gray-400">Open Teams and start meeting</div>
                  </div>
                  <ArrowRight className="w-5 h-5 text-gray-400" />
                </a>

                <a
                  href="https://meet.google.com/new"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl hover:scale-105 transition-all border-2 border-green-200 dark:border-green-700"
                >
                  <div className="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                    <VideoIcon className="w-6 h-6 text-white" />
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold text-gray-900 dark:text-white">Start Google Meet</div>
                    <div className="text-xs text-gray-600 dark:text-gray-400">Create new Google Meet session</div>
                  </div>
                  <ArrowRight className="w-5 h-5 text-gray-400" />
                </a>
              </div>

              <button
                onClick={() => setShowMeetingModal(false)}
                className="w-full mt-6 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl font-semibold hover:scale-105 transition-all"
              >
                Close
              </button>
            </div>
          </div>
        )}

        {/* Profile Picture Upload Modal */}
        {showProfileUploadModal && uploadingEmployee && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={() => setShowProfileUploadModal(false)}>
            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full shadow-2xl" onClick={(e) => e.stopPropagation()}>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold text-gray-900 dark:text-white">ðŸ“¸ Upload Profile Picture</h2>
                <button onClick={() => setShowProfileUploadModal(false)} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="mb-6 text-center">
                <div className="flex justify-center mb-4">
                  <AvatarImage
                    name={uploadingEmployee.name}
                    email={uploadingEmployee.email}
                    src={uploadingEmployee.profilePicture}
                    size="xl"
                    showBorder={false}
                    className="shadow-lg"
                  />
                </div>
                <p className="font-semibold text-gray-900 dark:text-white">{uploadingEmployee.name}</p>
                <p className="text-sm text-gray-600 dark:text-gray-400">{uploadingEmployee.role}</p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-900 dark:text-white mb-2">
                    Upload New Photo
                  </label>
                  <input
                    type="file"
                    accept="image/*"
                    onChange={(e) => {
                      const file = e.target.files?.[0];
                      if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                          // Update employee profile picture
                          const updatedEmployees = employees.map(emp => 
                            emp.id === uploadingEmployee.id 
                              ? { ...emp, profilePicture: 'ðŸ‘¤' } // Would store base64 image in real app
                              : emp
                          );
                          setEmployees(updatedEmployees);
                          alert(`Profile picture updated for ${uploadingEmployee.name}!`);
                          setShowProfileUploadModal(false);
                        };
                        reader.readAsDataURL(file);
                      }
                    }}
                    className="w-full px-4 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:border-blue-500 cursor-pointer"
                  />
                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    Accepted formats: JPG, PNG, GIF (max 5MB)
                  </p>
                </div>

                <div className="border-t border-gray-200 dark:border-gray-700 pt-4">
                  <p className="text-sm font-semibold text-gray-900 dark:text-white mb-3">Or choose an emoji:</p>
                  <div className="grid grid-cols-6 gap-2">
                    {['ðŸ‘¨', 'ðŸ‘©', 'ðŸ§‘', 'ðŸ‘¨â€ðŸ’¼', 'ðŸ‘©â€ðŸ’¼', 'ðŸ‘¨â€ðŸ’»', 'ðŸ‘©â€ðŸ’»', 'ðŸ‘¨â€ðŸŽ¨', 'ðŸ‘©â€ðŸŽ¨', 'ðŸ‘¨â€ðŸ”§', 'ðŸ‘©â€ðŸ”§', 'ðŸ§‘â€ðŸš€'].map((emoji) => (
                      <button
                        key={emoji}
                        onClick={() => {
                          const updatedEmployees = employees.map(emp => 
                            emp.id === uploadingEmployee.id 
                              ? { ...emp, profilePicture: emoji }
                              : emp
                          );
                          setEmployees(updatedEmployees);
                          setShowProfileUploadModal(false);
                        }}
                        className="text-4xl p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-all hover:scale-110"
                      >
                        {emoji}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <button
                onClick={() => setShowProfileUploadModal(false)}
                className="w-full mt-6 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-xl font-semibold hover:scale-105 transition-all"
              >
                Cancel
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
